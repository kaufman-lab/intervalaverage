<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Introduction to intervalaverage • intervalaverage</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Advanced Introduction to intervalaverage">
<meta property="og:description" content="intervalaverage">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">intervalaverage</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.9.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intervalaverage-advanced.html">Advanced Introduction to intervalaverage</a>
    </li>
    <li>
      <a href="../articles/intervalaverage-intro.html">Quick Introduction to intervalaverage</a>
    </li>
    <li>
      <a href="../articles/intervalaverage-technicaloverview.html">Technical overview of the intervalaverage function</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Advanced Introduction to intervalaverage</h1>
            
            <h4 data-toc-skip class="date">2023-01-20</h4>
      
      
      <div class="hidden name"><code>intervalaverage-advanced.Rmd</code></div>

    </div>

    
    
<p>This package and vignette makes extensive use of
<code>data.table</code>. If you’re unfamiliar with the
<code>data.table</code> syntax, a brief review of that package’s
introductory vignette may be useful.</p>
<div class="section level2">
<h2 id="averaging-values-measured-over-intervals">Averaging values measured over intervals<a class="anchor" aria-label="anchor" href="#averaging-values-measured-over-intervals"></a>
</h2>
<p>Consider the following dataset which represents average (predicted)
pm2.5 exposure and no2 exposure at some location over four sequential
7-day periods at the beginning of the year 2000:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exposure_dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>location_id<span class="op">=</span><span class="fl">1</span>, start<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="st">"2000-01-01"</span><span class="op">)</span>,by<span class="op">=</span><span class="fl">7</span>,length<span class="op">=</span><span class="fl">4</span><span class="op">)</span>,</span>
<span>                end<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="st">"2000-01-07"</span><span class="op">)</span>,by<span class="op">=</span><span class="fl">7</span>,length<span class="op">=</span><span class="fl">4</span><span class="op">)</span>,pm25<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">4</span>,mean<span class="op">=</span><span class="fl">15</span><span class="op">)</span>, no2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">4</span>,mean<span class="op">=</span><span class="fl">25</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">exposure_dataset</span></span>
<span><span class="co">#&gt;    location_id      start        end     pm25      no2</span></span>
<span><span class="co">#&gt; 1:           1 2000-01-01 2000-01-07 14.37355 25.32951</span></span>
<span><span class="co">#&gt; 2:           1 2000-01-08 2000-01-14 15.18364 24.17953</span></span>
<span><span class="co">#&gt; 3:           1 2000-01-15 2000-01-21 14.16437 25.48743</span></span>
<span><span class="co">#&gt; 4:           1 2000-01-22 2000-01-28 16.59528 25.73832</span></span></code></pre></div>
<p>Note that the above intervals are stored as a column for the start of
the interval and a column for the end of the interval. For the purpose
of this package, intervals are ALWAYS treated as closed (i.e. inclusive
of start and end values) and the variables storing interval starts and
ends must be discrete (e.g., class integer or IDate).</p>
<p>If we wanted to calculate the average of the first two weeks of pm25
data, this would simply be the average of the two pm25 values for those
weeks:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exposure_dataset</span><span class="op">[</span><span class="va">start</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2000-01-01"</span>,<span class="st">"2000-01-08"</span><span class="op">)</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">pm25</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 14.77859</span></span></code></pre></div>
<p>But we wanted the average of the first 10 days of that pm25 data, we
would need to take a weighted average since the period from Jan 1 to Jan
10 doesn’t align perfectly with the intervals over which the pm2.5 data
is recorded:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exposure_dataset</span><span class="op">[</span><span class="va">start</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2000-01-01"</span>,<span class="st">"2000-01-08"</span><span class="op">)</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="va">pm25</span>,w<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span><span class="op">/</span><span class="fl">10</span>,<span class="fl">3</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 14.61658</span></span></code></pre></div>
<p>The <code>intervalaverage</code> package and specifically the
<code>intervalaverage</code> function was written to facilitate this
sort averaging operation. In order to use this the package function,
we’ll need a dataset containing data that’s stored over intervals (such
as in <code>exposure_dataset</code>) as well as a dataset containing the
periods you’d like to average over.</p>
<p>Let’s create a dataset containing some periods we’d like averages
over:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">averaging_periods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>start<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="st">"2000-01-01"</span><span class="op">)</span>,by<span class="op">=</span><span class="fl">10</span>,length<span class="op">=</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>                end<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="st">"2000-01-10"</span><span class="op">)</span>,by<span class="op">=</span><span class="fl">10</span>,length<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">averaging_periods</span></span>
<span><span class="co">#&gt;         start        end</span></span>
<span><span class="co">#&gt; 1: 2000-01-01 2000-01-10</span></span>
<span><span class="co">#&gt; 2: 2000-01-11 2000-01-20</span></span>
<span><span class="co">#&gt; 3: 2000-01-21 2000-01-30</span></span></code></pre></div>
<p>Now that we have defined intervals to average over, let’s use the
<code>intervalaverage</code> function to calculate the averages:</p>
<p>Note that in order for the intervalaverage function to work, the
start and end columns need to have the same column names in
<code>x</code> and in <code>y</code>. These column names are specified
via the <code>interval_vars</code> argument. And the variables in
<code>x</code> that you want averages calculated for are specified via
<code>value_vars</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">averaged_exposures</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/intervalaverage.html">intervalaverage</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">exposure_dataset</span>,y<span class="op">=</span><span class="va">averaging_periods</span>,</span>
<span>                                      interval_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start"</span>,<span class="st">"end"</span><span class="op">)</span>,value_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pm25"</span>,<span class="st">"no2"</span><span class="op">)</span></span>
<span>                                      <span class="op">)</span></span>
<span><span class="va">averaged_exposures</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">start</span>,<span class="va">end</span>,<span class="va">pm25</span>,<span class="va">no2</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt;         start        end     pm25      no2</span></span>
<span><span class="co">#&gt; 1: 2000-01-01 2000-01-10 14.61658 24.98451</span></span>
<span><span class="co">#&gt; 2: 2000-01-11 2000-01-20 14.57208 24.96427</span></span>
<span><span class="co">#&gt; 3: 2000-01-21 2000-01-30       NA       NA</span></span></code></pre></div>
<p>The return value of the <code>intervalaverage</code> function is a
<code>data.table</code>. Just the first four columns of that return
data.table are printed. The return data.table always contains the exact
intervals specified in y (and, as such, the number of rows of the return
is always the number of rows in <code>y</code>). The return also
contains a column for each <code>value_var</code> specified from x.
These columns contain the values of the variables from <code>x</code>
averaged over periods in <code>y</code>. Note that the value of the pm25
in the first row is what we calculated manually above.</p>
<p>Note that the third entry for both the <code>pm25</code> and the
<code>no2</code> column is <code>NA</code> or missing. This makes sense
because the <code>x</code> ( <code>exposure_dataset</code>) didn’t have
measurements for every day in the interval in <code>y</code>
(<code>averaging_periods</code>) from Jan 21, 2000 to Jan 30, 2000.</p>
<p>Displaying the full data.table returned by the function gives us some
more information:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">averaged_exposures</span></span>
<span><span class="co">#&gt;         start        end     pm25      no2 yduration xduration nobs_pm25</span></span>
<span><span class="co">#&gt; 1: 2000-01-01 2000-01-10 14.61658 24.98451        10        10        10</span></span>
<span><span class="co">#&gt; 2: 2000-01-11 2000-01-20 14.57208 24.96427        10        10        10</span></span>
<span><span class="co">#&gt; 3: 2000-01-21 2000-01-30       NA       NA        10         8         8</span></span>
<span><span class="co">#&gt;    nobs_no2  xminstart    xmaxend maxgap_pm25 maxgap_no2</span></span>
<span><span class="co">#&gt; 1:       10 2000-01-01 2000-01-10           0          0</span></span>
<span><span class="co">#&gt; 2:       10 2000-01-11 2000-01-20           0          0</span></span>
<span><span class="co">#&gt; 3:        8 2000-01-21 2000-01-28           2          2</span></span></code></pre></div>
<p>The <code>xduration</code> column tells us the number of days that
were present in <code>x</code> for each interval specified in
<code>y</code>. The first two <code>averaging_periods</code> intervals
were fully represented in <code>x</code>, whereas <code>x</code> only
contained data for 8 of the 10 days in the third <code>y</code>
interval. The <code>xmaxend</code> column shows us that the last day in
the interval from Jan 21,2000 to Jan 30, 2000 that was present in
<code>y</code> was Jan 28, 2000.</p>
<p>These supplementary columns are useful for diagnosing incomplete data
in <code>exposure_dataset</code>.</p>
<p>If we’re ok with calculating an average based on incomplete data, we
can set the the tolerance for missingness lower. Let’s say we’re ok with
calculating a non-missing average if 75% or more of the period is
observed:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/intervalaverage.html">intervalaverage</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">exposure_dataset</span>,</span>
<span>                y<span class="op">=</span><span class="va">averaging_periods</span>,</span>
<span>                interval_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start"</span>,<span class="st">"end"</span><span class="op">)</span>,</span>
<span>                value_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pm25"</span>,<span class="st">"no2"</span><span class="op">)</span>,</span>
<span>                required_percentage <span class="op">=</span> <span class="fl">75</span><span class="op">)</span></span>
<span><span class="co">#&gt;         start        end     pm25      no2 yduration xduration nobs_pm25</span></span>
<span><span class="co">#&gt; 1: 2000-01-01 2000-01-10 14.61658 24.98451        10        10        10</span></span>
<span><span class="co">#&gt; 2: 2000-01-11 2000-01-20 14.57208 24.96427        10        10        10</span></span>
<span><span class="co">#&gt; 3: 2000-01-21 2000-01-30 16.29142 25.70696        10         8         8</span></span>
<span><span class="co">#&gt;    nobs_no2  xminstart    xmaxend maxgap_pm25 maxgap_no2</span></span>
<span><span class="co">#&gt; 1:       10 2000-01-01 2000-01-10           0          0</span></span>
<span><span class="co">#&gt; 2:       10 2000-01-11 2000-01-20           0          0</span></span>
<span><span class="co">#&gt; 3:        8 2000-01-21 2000-01-28           2          2</span></span></code></pre></div>
<p>The results are the same for the first two rows but now we have
nonmissing values in the third which are calculated based on the
available data in <code>exposure_dataset</code>. If there had been a
period with less than 75% of the data present, the function would still
return <code>NA</code> for those value variables.</p>
</div>
<div class="section level2">
<h2 id="averaging-within-values-of-a-grouping-variable-e-g--at-multiple-locations">Averaging within values of a grouping variable (e.g. at multiple
locations)<a class="anchor" aria-label="anchor" href="#averaging-within-values-of-a-grouping-variable-e-g--at-multiple-locations"></a>
</h2>
<p>Often, we might have interval data at more than one location or
identifier at a time. Let’s create a data.table similar to
<code>exposure_dataset</code> but with several (three) locations:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exposure_dataset2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>location_id<span class="op">=</span><span class="va">z</span>, </span>
<span>             start<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="st">"2000-01-01"</span><span class="op">)</span>,by<span class="op">=</span><span class="fl">7</span>,length<span class="op">=</span><span class="fl">4</span><span class="op">)</span>,</span>
<span>             end<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="st">"2000-01-07"</span><span class="op">)</span>,by<span class="op">=</span><span class="fl">7</span>,length<span class="op">=</span><span class="fl">4</span><span class="op">)</span>,pm25<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">4</span>,mean<span class="op">=</span><span class="fl">15</span><span class="op">)</span>,</span>
<span>             no2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">4</span>,mean<span class="op">=</span><span class="fl">25</span><span class="op">)</span><span class="op">)</span><span class="op">}</span> <span class="op">)</span><span class="op">)</span></span>
<span><span class="va">exposure_dataset2</span></span>
<span><span class="co">#&gt;     location_id      start        end     pm25      no2</span></span>
<span><span class="co">#&gt;  1:           1 2000-01-01 2000-01-07 15.57578 24.37876</span></span>
<span><span class="co">#&gt;  2:           1 2000-01-08 2000-01-14 14.69461 22.78530</span></span>
<span><span class="co">#&gt;  3:           1 2000-01-15 2000-01-21 16.51178 26.12493</span></span>
<span><span class="co">#&gt;  4:           1 2000-01-22 2000-01-28 15.38984 24.95507</span></span>
<span><span class="co">#&gt;  5:           2 2000-01-01 2000-01-07 14.98381 25.91898</span></span>
<span><span class="co">#&gt;  6:           2 2000-01-08 2000-01-14 15.94384 25.78214</span></span>
<span><span class="co">#&gt;  7:           2 2000-01-15 2000-01-21 15.82122 25.07456</span></span>
<span><span class="co">#&gt;  8:           2 2000-01-22 2000-01-28 15.59390 23.01065</span></span>
<span><span class="co">#&gt;  9:           3 2000-01-01 2000-01-07 15.61983 24.52185</span></span>
<span><span class="co">#&gt; 10:           3 2000-01-08 2000-01-14 14.94387 25.41794</span></span>
<span><span class="co">#&gt; 11:           3 2000-01-15 2000-01-21 14.84420 26.35868</span></span>
<span><span class="co">#&gt; 12:           3 2000-01-22 2000-01-28 13.52925 24.89721</span></span></code></pre></div>
<p>If you want to use the <code>intervalaverage</code> function to
calculate averages of values in <code>x</code> over a set of averaging
periods separately for each level of an identifier variable, that
identifier variable needs to be crossed with every averaging period in
<code>y</code>. It takes an extra step to cross the identifier with the
averaging periods to create <code>y</code>, but in creating
<code>y</code> this way you explicitly define the form of the return
value of <code>intervalaverage</code>, since
<code>intervalaverage</code> always returns one row for each row in
<code>y</code>.</p>
<p>Let’s cross the previous averaging periods table with every unique
value of the identifier in the new exposure dataset:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#unexpanded:</span></span>
<span><span class="va">averaging_periods</span></span>
<span><span class="co">#&gt;         start        end</span></span>
<span><span class="co">#&gt; 1: 2000-01-01 2000-01-10</span></span>
<span><span class="co">#&gt; 2: 2000-01-11 2000-01-20</span></span>
<span><span class="co">#&gt; 3: 2000-01-21 2000-01-30</span></span>
<span><span class="co">#expanded to every location_id:</span></span>
<span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">averaging_periods</span><span class="op">)</span><span class="op">[</span>,<span class="va">location_id</span><span class="op">:=</span><span class="va">z</span><span class="op">]</span><span class="op">[</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="co">#&gt;         start        end location_id</span></span>
<span><span class="co">#&gt; 1: 2000-01-01 2000-01-10           1</span></span>
<span><span class="co">#&gt; 2: 2000-01-11 2000-01-20           1</span></span>
<span><span class="co">#&gt; 3: 2000-01-21 2000-01-30           1</span></span>
<span><span class="co">#&gt; 4: 2000-01-01 2000-01-10           2</span></span>
<span><span class="co">#&gt; 5: 2000-01-11 2000-01-20           2</span></span>
<span><span class="co">#&gt; 6: 2000-01-21 2000-01-30           2</span></span>
<span><span class="co">#&gt; 7: 2000-01-01 2000-01-10           3</span></span>
<span><span class="co">#&gt; 8: 2000-01-11 2000-01-20           3</span></span>
<span><span class="co">#&gt; 9: 2000-01-21 2000-01-30           3</span></span></code></pre></div>
<p>The above code is a bit esoteric so the intervalaverage package
contains function to simplify and generalize this process of
repeating/expanding a set of intervals (or more generally, a set of rows
in a table) for every <code>location_id</code> (or more generally, for
every row in another table). To use this <code>CJ.dt</code> function,
just create a <code>data.table</code> with a column containing unique
ids, then call <code>CJ.dt</code> on the two tables:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exposure_dataset2_unique_locs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>location_id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">exposure_dataset2</span><span class="op">$</span><span class="va">location_id</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">averaging_periods2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CJ.dt.html">CJ.dt</a></span><span class="op">(</span><span class="va">averaging_periods</span>, <span class="va">exposure_dataset2_unique_locs</span><span class="op">)</span></span>
<span><span class="va">averaging_periods2</span></span>
<span><span class="co">#&gt;         start        end location_id</span></span>
<span><span class="co">#&gt; 1: 2000-01-01 2000-01-10           1</span></span>
<span><span class="co">#&gt; 2: 2000-01-11 2000-01-20           1</span></span>
<span><span class="co">#&gt; 3: 2000-01-21 2000-01-30           1</span></span>
<span><span class="co">#&gt; 4: 2000-01-01 2000-01-10           2</span></span>
<span><span class="co">#&gt; 5: 2000-01-11 2000-01-20           2</span></span>
<span><span class="co">#&gt; 6: 2000-01-21 2000-01-30           2</span></span>
<span><span class="co">#&gt; 7: 2000-01-01 2000-01-10           3</span></span>
<span><span class="co">#&gt; 8: 2000-01-11 2000-01-20           3</span></span>
<span><span class="co">#&gt; 9: 2000-01-21 2000-01-30           3</span></span>
<span></span>
<span><span class="co">#or, more concisely:</span></span>
<span><span class="va">averaging_periods2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CJ.dt.html">CJ.dt</a></span><span class="op">(</span><span class="va">averaging_periods</span>, <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">exposure_dataset2</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">location_id</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now, to take averages of <code>x</code> values over intervals in
<code>y</code> within groups, all we have to do is use the same call as
in the first example to <code>intervalaverage</code> while specifying
one more argument: <code>group_vars="location_id"</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/intervalaverage.html">intervalaverage</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">exposure_dataset2</span>,</span>
<span>                y<span class="op">=</span><span class="va">averaging_periods2</span>,</span>
<span>                interval_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start"</span>,<span class="st">"end"</span><span class="op">)</span>,</span>
<span>                value_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pm25"</span>,<span class="st">"no2"</span><span class="op">)</span>,</span>
<span>                group_vars<span class="op">=</span><span class="st">"location_id"</span>,</span>
<span>                required_percentage <span class="op">=</span> <span class="fl">75</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">location_id</span>, <span class="va">start</span>,<span class="va">end</span>, <span class="va">pm25</span>,<span class="va">no2</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt;    location_id      start        end     pm25      no2</span></span>
<span><span class="co">#&gt; 1:           1 2000-01-01 2000-01-10 15.31143 23.90072</span></span>
<span><span class="co">#&gt; 2:           1 2000-01-11 2000-01-20 15.78491 24.78908</span></span>
<span><span class="co">#&gt; 3:           1 2000-01-21 2000-01-30 15.53009 25.10130</span></span>
<span><span class="co">#&gt; 4:           2 2000-01-01 2000-01-10 15.27182 25.87793</span></span>
<span><span class="co">#&gt; 5:           2 2000-01-11 2000-01-20 15.87027 25.35759</span></span>
<span><span class="co">#&gt; 6:           2 2000-01-21 2000-01-30 15.62232 23.26864</span></span>
<span><span class="co">#&gt; 7:           3 2000-01-01 2000-01-10 15.41704 24.79068</span></span>
<span><span class="co">#&gt; 8:           3 2000-01-11 2000-01-20 14.88407 25.98238</span></span>
<span><span class="co">#&gt; 9:           3 2000-01-21 2000-01-30 13.69362 25.07990</span></span></code></pre></div>
<p>The <code>group_vars</code> argument tells the
<code>intervalaverage</code> function to calculate averages separately
within each group.</p>
<p>Of course, we could have completed the above by calling
<code>intervalaverage</code> repeatedly for each value of
<code>location_id</code> in <code>x</code> and <code>y</code> using a
for loop. The reason to prefer using the <code>group_vars</code>
approach is that the <code>intervalaverage</code> function is written to
be faster than looping when with dealing with grouping. It also saves
you the trouble of writing a loop and combining the results.</p>
<p>Additionally, <code>group_vars</code> accepts a vector of character
column names, meaning that you can calculate averages within
combinations of groups without writing nested for loops.</p>
</div>
<div class="section level2">
<h2 id="values-in-overlapping-periods-are-not-allowed">Values in overlapping periods are not allowed<a class="anchor" aria-label="anchor" href="#values-in-overlapping-periods-are-not-allowed"></a>
</h2>
<p>Note that all the intervals used in this package are treated as
inclusive. So far, we’ve dealt with data which have intervals which do
not overlap. However, consider the following dataset where the end day
of a previous interval is the start day of the next interval:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exposure_dataset_overlapping</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>location_id<span class="op">=</span><span class="va">z</span>, </span>
<span>             start<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="st">"2000-01-01"</span><span class="op">)</span>,by<span class="op">=</span><span class="fl">7</span>,length<span class="op">=</span><span class="fl">4</span><span class="op">)</span>,</span>
<span>             end<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="st">"2000-01-08"</span><span class="op">)</span>,by<span class="op">=</span><span class="fl">7</span>,length<span class="op">=</span><span class="fl">4</span><span class="op">)</span>,</span>
<span>             pm25<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">4</span>,mean<span class="op">=</span><span class="fl">15</span><span class="op">)</span>,</span>
<span>             no2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">4</span>,mean<span class="op">=</span><span class="fl">25</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="op">}</span> <span class="op">)</span><span class="op">)</span></span>
<span><span class="va">exposure_dataset_overlapping</span></span>
<span><span class="co">#&gt;     location_id      start        end     pm25      no2</span></span>
<span><span class="co">#&gt;  1:           1 2000-01-01 2000-01-08 15.38767 24.60571</span></span>
<span><span class="co">#&gt;  2:           1 2000-01-08 2000-01-15 14.94619 24.94069</span></span>
<span><span class="co">#&gt;  3:           1 2000-01-15 2000-01-22 13.62294 26.10003</span></span>
<span><span class="co">#&gt;  4:           1 2000-01-22 2000-01-29 14.58501 25.76318</span></span>
<span><span class="co">#&gt;  5:           2 2000-01-01 2000-01-08 14.83548 24.31124</span></span>
<span><span class="co">#&gt;  6:           2 2000-01-08 2000-01-15 14.74664 24.29250</span></span>
<span><span class="co">#&gt;  7:           2 2000-01-15 2000-01-22 15.69696 25.36458</span></span>
<span><span class="co">#&gt;  8:           2 2000-01-22 2000-01-29 15.55666 25.76853</span></span>
<span><span class="co">#&gt;  9:           3 2000-01-01 2000-01-08 14.88765 25.34112</span></span>
<span><span class="co">#&gt; 10:           3 2000-01-08 2000-01-15 15.88111 23.87064</span></span>
<span><span class="co">#&gt; 11:           3 2000-01-15 2000-01-22 15.39811 26.43302</span></span>
<span><span class="co">#&gt; 12:           3 2000-01-22 2000-01-29 14.38797 26.98040</span></span></code></pre></div>
<p>If we try to average this exposure dataset, we get an error:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/intervalaverage.html">intervalaverage</a></span><span class="op">(</span><span class="va">exposure_dataset_overlapping</span>,<span class="va">averaging_periods2</span>,</span>
<span>                interval_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start"</span>,<span class="st">"end"</span><span class="op">)</span>,</span>
<span>                value_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pm25"</span>,<span class="st">"no2"</span><span class="op">)</span>,</span>
<span>                group_vars<span class="op">=</span><span class="st">"location_id"</span>,</span>
<span>                required_percentage <span class="op">=</span> <span class="fl">75</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in intervalaverage(exposure_dataset_overlapping, averaging_periods2, : overlapping intervals detected</span></span></code></pre></div>
<p>That’s because the <code>intervalaverage</code> function is written
to throw an error if there are overlaps in within groups. This is to
encourage the user to explicitly and consciously deal with overlaps
prior to averaging.</p>
<p>Note that we can also check whether there are overlapping intervals
(within specified groups) using <code>is.overlapping</code></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/is.overlapping.html">is.overlapping</a></span><span class="op">(</span><span class="va">exposure_dataset_overlapping</span>, interval_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'start'</span>,<span class="st">'end'</span><span class="op">)</span>,group_vars<span class="op">=</span><span class="st">"location_id"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>In order to deal with partially overlapping intervals, we need to
split intervals into areas of exact overlap and non-overlap with the
<code>isolateoverlaps</code> function:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exposure_dataset_isolated</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/isolateoverlaps.html">isolateoverlaps</a></span><span class="op">(</span><span class="va">exposure_dataset_overlapping</span>, </span>
<span>                                             interval_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start"</span>,<span class="st">"end"</span><span class="op">)</span>, </span>
<span>                                             group_vars<span class="op">=</span><span class="st">"location_id"</span>,</span>
<span>                                             interval_vars_out<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start2"</span>,<span class="st">"end2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">exposure_dataset_isolated</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">15</span><span class="op">]</span> <span class="co">#only show the first 15 rows</span></span>
<span><span class="co">#&gt;     location_id     start2       end2      start        end     pm25      no2</span></span>
<span><span class="co">#&gt;  1:           1 2000-01-01 2000-01-07 2000-01-01 2000-01-08 15.38767 24.60571</span></span>
<span><span class="co">#&gt;  2:           1 2000-01-08 2000-01-08 2000-01-01 2000-01-08 15.38767 24.60571</span></span>
<span><span class="co">#&gt;  3:           1 2000-01-08 2000-01-08 2000-01-08 2000-01-15 14.94619 24.94069</span></span>
<span><span class="co">#&gt;  4:           1 2000-01-09 2000-01-14 2000-01-08 2000-01-15 14.94619 24.94069</span></span>
<span><span class="co">#&gt;  5:           1 2000-01-15 2000-01-15 2000-01-08 2000-01-15 14.94619 24.94069</span></span>
<span><span class="co">#&gt;  6:           1 2000-01-15 2000-01-15 2000-01-15 2000-01-22 13.62294 26.10003</span></span>
<span><span class="co">#&gt;  7:           1 2000-01-16 2000-01-21 2000-01-15 2000-01-22 13.62294 26.10003</span></span>
<span><span class="co">#&gt;  8:           1 2000-01-22 2000-01-22 2000-01-15 2000-01-22 13.62294 26.10003</span></span>
<span><span class="co">#&gt;  9:           1 2000-01-22 2000-01-22 2000-01-22 2000-01-29 14.58501 25.76318</span></span>
<span><span class="co">#&gt; 10:           1 2000-01-23 2000-01-29 2000-01-22 2000-01-29 14.58501 25.76318</span></span>
<span><span class="co">#&gt; 11:           2 2000-01-01 2000-01-07 2000-01-01 2000-01-08 14.83548 24.31124</span></span>
<span><span class="co">#&gt; 12:           2 2000-01-08 2000-01-08 2000-01-01 2000-01-08 14.83548 24.31124</span></span>
<span><span class="co">#&gt; 13:           2 2000-01-08 2000-01-08 2000-01-08 2000-01-15 14.74664 24.29250</span></span>
<span><span class="co">#&gt; 14:           2 2000-01-09 2000-01-14 2000-01-08 2000-01-15 14.74664 24.29250</span></span>
<span><span class="co">#&gt; 15:           2 2000-01-15 2000-01-15 2000-01-08 2000-01-15 14.74664 24.29250</span></span></code></pre></div>
<p>Inspect the above table and compare it to
<code>exposure_dataset</code>. <code>start2</code> and <code>end2</code>
are the new intervals and <code>start</code> and <code>end</code> are
the original intervals. Note how there are two rows for every
overlapping period (ie in the <code>start2</code> and <code>end2</code>
columns), but the pm25 and no2 values differ within these rows since one
value comes from the first overlapping period and the second value comes
from the second overlapping period.</p>
<p>We can then average exposure values within periods of exact
overlap:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exposure_dataset_overlaps_averaged</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">exposure_dataset_isolated</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pm25<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">pm25</span><span class="op">)</span>,no2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">no2</span><span class="op">)</span><span class="op">)</span>,by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"location_id"</span>,<span class="st">"start2"</span>,<span class="st">"end2"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">exposure_dataset_overlaps_averaged</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start2"</span>,<span class="st">"end2"</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start"</span>,<span class="st">"end"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">exposure_dataset_overlaps_averaged</span></span>
<span><span class="co">#&gt;     location_id      start        end     pm25      no2</span></span>
<span><span class="co">#&gt;  1:           1 2000-01-01 2000-01-07 15.38767 24.60571</span></span>
<span><span class="co">#&gt;  2:           1 2000-01-08 2000-01-08 15.16693 24.77320</span></span>
<span><span class="co">#&gt;  3:           1 2000-01-09 2000-01-14 14.94619 24.94069</span></span>
<span><span class="co">#&gt;  4:           1 2000-01-15 2000-01-15 14.28457 25.52036</span></span>
<span><span class="co">#&gt;  5:           1 2000-01-16 2000-01-21 13.62294 26.10003</span></span>
<span><span class="co">#&gt;  6:           1 2000-01-22 2000-01-22 14.10397 25.93160</span></span>
<span><span class="co">#&gt;  7:           1 2000-01-23 2000-01-29 14.58501 25.76318</span></span>
<span><span class="co">#&gt;  8:           2 2000-01-01 2000-01-07 14.83548 24.31124</span></span>
<span><span class="co">#&gt;  9:           2 2000-01-08 2000-01-08 14.79106 24.30187</span></span>
<span><span class="co">#&gt; 10:           2 2000-01-09 2000-01-14 14.74664 24.29250</span></span>
<span><span class="co">#&gt; 11:           2 2000-01-15 2000-01-15 15.22180 24.82854</span></span>
<span><span class="co">#&gt; 12:           2 2000-01-16 2000-01-21 15.69696 25.36458</span></span>
<span><span class="co">#&gt; 13:           2 2000-01-22 2000-01-22 15.62681 25.56656</span></span>
<span><span class="co">#&gt; 14:           2 2000-01-23 2000-01-29 15.55666 25.76853</span></span>
<span><span class="co">#&gt; 15:           3 2000-01-01 2000-01-07 14.88765 25.34112</span></span>
<span><span class="co">#&gt; 16:           3 2000-01-08 2000-01-08 15.38438 24.60588</span></span>
<span><span class="co">#&gt; 17:           3 2000-01-09 2000-01-14 15.88111 23.87064</span></span>
<span><span class="co">#&gt; 18:           3 2000-01-15 2000-01-15 15.63961 25.15183</span></span>
<span><span class="co">#&gt; 19:           3 2000-01-16 2000-01-21 15.39811 26.43302</span></span>
<span><span class="co">#&gt; 20:           3 2000-01-22 2000-01-22 14.89304 26.70671</span></span>
<span><span class="co">#&gt; 21:           3 2000-01-23 2000-01-29 14.38797 26.98040</span></span>
<span><span class="co">#&gt;     location_id      start        end     pm25      no2</span></span></code></pre></div>
<p>This version of the dataset where values in overlapping periods have
already been averaged can now be averaged to the times in
<code>averaging_periods2</code> using the <code>intervalaverage</code>
function:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/intervalaverage.html">intervalaverage</a></span><span class="op">(</span><span class="va">exposure_dataset_overlaps_averaged</span>,</span>
<span>                <span class="va">averaging_periods2</span>,</span>
<span>                interval_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start"</span>,<span class="st">"end"</span><span class="op">)</span>,</span>
<span>                value_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pm25"</span>,<span class="st">"no2"</span><span class="op">)</span>,</span>
<span>                group_vars<span class="op">=</span><span class="st">"location_id"</span>,</span>
<span>                required_percentage <span class="op">=</span> <span class="fl">75</span><span class="op">)</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">location_id</span>, <span class="va">start</span>,<span class="va">end</span>,<span class="va">pm25</span>,<span class="va">no2</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt;    location_id      start        end     pm25      no2</span></span>
<span><span class="co">#&gt; 1:           1 2000-01-01 2000-01-10 15.27730 24.68945</span></span>
<span><span class="co">#&gt; 2:           1 2000-01-11 2000-01-20 14.21840 25.57832</span></span>
<span><span class="co">#&gt; 3:           1 2000-01-21 2000-01-30 14.42466 25.81932</span></span>
<span><span class="co">#&gt; 4:           2 2000-01-01 2000-01-10 14.81327 24.30656</span></span>
<span><span class="co">#&gt; 5:           2 2000-01-11 2000-01-20 15.26932 24.88215</span></span>
<span><span class="co">#&gt; 6:           2 2000-01-21 2000-01-30 15.58005 25.70121</span></span>
<span><span class="co">#&gt; 7:           3 2000-01-01 2000-01-10 15.13602 24.97350</span></span>
<span><span class="co">#&gt; 8:           3 2000-01-11 2000-01-20 15.61546 25.27995</span></span>
<span><span class="co">#&gt; 9:           3 2000-01-21 2000-01-30 14.55633 26.88917</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="overlapping-averaging-periods">Overlapping averaging periods<a class="anchor" aria-label="anchor" href="#overlapping-averaging-periods"></a>
</h2>
<p>While overlapping periods in <code>x</code> are not allowed, there’s
nothing wrong with averaging to multiple partially overlapping periods
in y at the same time:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">overlapping_averaging_periods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>start<span class="op">=</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2000-01-01"</span>,<span class="st">"2000-01-01"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                            end<span class="op">=</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2000-01-10"</span>,<span class="st">"2000-01-20"</span><span class="op">)</span><span class="op">)</span></span>
<span>                                            <span class="op">)</span></span>
<span><span class="va">overlapping_averaging_periods</span></span>
<span><span class="co">#&gt;         start        end</span></span>
<span><span class="co">#&gt; 1: 2000-01-01 2000-01-10</span></span>
<span><span class="co">#&gt; 2: 2000-01-01 2000-01-20</span></span>
<span><span class="va">overlapping_averaging_periods_expanded</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/CJ.dt.html">CJ.dt</a></span><span class="op">(</span><span class="va">overlapping_averaging_periods</span>,<span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">exposure_dataset2</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">location_id</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">overlapping_averaging_periods_expanded</span></span>
<span><span class="co">#&gt;         start        end location_id</span></span>
<span><span class="co">#&gt; 1: 2000-01-01 2000-01-10           1</span></span>
<span><span class="co">#&gt; 2: 2000-01-01 2000-01-20           1</span></span>
<span><span class="co">#&gt; 3: 2000-01-01 2000-01-10           2</span></span>
<span><span class="co">#&gt; 4: 2000-01-01 2000-01-20           2</span></span>
<span><span class="co">#&gt; 5: 2000-01-01 2000-01-10           3</span></span>
<span><span class="co">#&gt; 6: 2000-01-01 2000-01-20           3</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="../reference/intervalaverage.html">intervalaverage</a></span><span class="op">(</span><span class="va">exposure_dataset_overlaps_averaged</span>,</span>
<span>                <span class="va">overlapping_averaging_periods_expanded</span>,</span>
<span>                interval_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start"</span>,<span class="st">"end"</span><span class="op">)</span>,</span>
<span>                value_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pm25"</span>,<span class="st">"no2"</span><span class="op">)</span>,</span>
<span>                group_vars<span class="op">=</span><span class="st">"location_id"</span>,</span>
<span>                required_percentage <span class="op">=</span> <span class="fl">75</span><span class="op">)</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">location_id</span>, <span class="va">start</span>,<span class="va">end</span>,<span class="va">pm25</span>,<span class="va">no2</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt;    location_id      start        end     pm25      no2</span></span>
<span><span class="co">#&gt; 1:           1 2000-01-01 2000-01-10 15.27730 24.68945</span></span>
<span><span class="co">#&gt; 2:           1 2000-01-01 2000-01-20 14.74785 25.13389</span></span>
<span><span class="co">#&gt; 3:           2 2000-01-01 2000-01-10 14.81327 24.30656</span></span>
<span><span class="co">#&gt; 4:           2 2000-01-01 2000-01-20 15.04129 24.59435</span></span>
<span><span class="co">#&gt; 5:           3 2000-01-01 2000-01-10 15.13602 24.97350</span></span>
<span><span class="co">#&gt; 6:           3 2000-01-01 2000-01-20 15.37574 25.12672</span></span></code></pre></div>
<p>Note that if you specify identical intervals (within groups defined
by <code>group_vars</code>), duplicate intervals in <code>y</code> will
be dropped with a warning resulting in a return data.table with fewer
rows than in <code>y</code>.</p>
</div>
<div class="section level2">
<h2 id="averaging-values-measured-over-intervals-different-averaging-periods-for-different-groups">Averaging values measured over intervals: different averaging
periods for different groups<a class="anchor" aria-label="anchor" href="#averaging-values-measured-over-intervals-different-averaging-periods-for-different-groups"></a>
</h2>
<p>Often we’re interested in calculating averages over different periods
for different locations. First to make this more realistic, let’s
generate ~20 years of data at 2000 locations:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_locs</span> <span class="op">&lt;-</span> <span class="fl">2000</span></span>
<span><span class="va">n_weeks</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">exposure_dataset3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_locs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>      location_id <span class="op">=</span> <span class="va">id</span>,</span>
<span>      start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="st">"2000-01-01"</span><span class="op">)</span>, by <span class="op">=</span> <span class="fl">7</span>, length <span class="op">=</span> <span class="va">n_weeks</span><span class="op">)</span>,</span>
<span>      end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="st">"2000-01-07"</span><span class="op">)</span>, by <span class="op">=</span> <span class="fl">7</span>, length <span class="op">=</span> <span class="va">n_weeks</span><span class="op">)</span>,</span>
<span>      pm25 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_weeks</span>, mean <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,</span>
<span>      no2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_weeks</span>, mean <span class="op">=</span> <span class="fl">25</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">exposure_dataset3</span></span>
<span><span class="co">#&gt;          location_id      start        end     pm25      no2</span></span>
<span><span class="co">#&gt;       1:           1 2000-01-01 2000-01-07 14.63278 26.21289</span></span>
<span><span class="co">#&gt;       2:           1 2000-01-08 2000-01-14 13.95587 24.37274</span></span>
<span><span class="co">#&gt;       3:           1 2000-01-15 2000-01-21 15.56972 26.71116</span></span>
<span><span class="co">#&gt;       4:           1 2000-01-22 2000-01-28 14.86495 24.60563</span></span>
<span><span class="co">#&gt;       5:           1 2000-01-29 2000-02-04 17.40162 22.67851</span></span>
<span><span class="co">#&gt;      ---                                                    </span></span>
<span><span class="co">#&gt; 1999996:        2000 2019-01-26 2019-02-01 15.00646 25.27885</span></span>
<span><span class="co">#&gt; 1999997:        2000 2019-02-02 2019-02-08 16.41525 26.14573</span></span>
<span><span class="co">#&gt; 1999998:        2000 2019-02-09 2019-02-15 15.29644 24.84448</span></span>
<span><span class="co">#&gt; 1999999:        2000 2019-02-16 2019-02-22 15.05604 24.01209</span></span>
<span><span class="co">#&gt; 2000000:        2000 2019-02-23 2019-03-01 17.37829 26.74711</span></span></code></pre></div>
<p>Now let’s pick a different random start and end date for each
location’s averaging period. We’ll pick start dates at random and define
the end the date as 3 years after each start date, thus creating
different three-year intervals for every location.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">averaging_periods3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>location_id<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">n_locs</span>,</span>
<span>                                 start<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span></span>
<span>                                   x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="st">"2000-01-01"</span><span class="op">)</span>,<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="st">"2019-12-31"</span><span class="op">)</span>,by<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>                                   size<span class="op">=</span><span class="va">n_locs</span></span>
<span>                                 <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">averaging_periods3</span><span class="op">[</span>,<span class="va">end</span><span class="op">:=</span><span class="va">start</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">3</span><span class="op">*</span><span class="fl">365.25</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">averaging_periods3</span></span>
<span><span class="co">#&gt;       location_id      start        end</span></span>
<span><span class="co">#&gt;    1:           1 2006-12-11 2009-12-11</span></span>
<span><span class="co">#&gt;    2:           2 2018-02-17 2021-02-17</span></span>
<span><span class="co">#&gt;    3:           3 2019-12-23 2022-12-23</span></span>
<span><span class="co">#&gt;    4:           4 2019-01-08 2022-01-08</span></span>
<span><span class="co">#&gt;    5:           5 2017-03-16 2020-03-16</span></span>
<span><span class="co">#&gt;   ---                                  </span></span>
<span><span class="co">#&gt; 1996:        1996 2012-09-19 2015-09-20</span></span>
<span><span class="co">#&gt; 1997:        1997 2003-04-09 2006-04-09</span></span>
<span><span class="co">#&gt; 1998:        1998 2001-03-31 2004-03-31</span></span>
<span><span class="co">#&gt; 1999:        1999 2016-12-11 2019-12-12</span></span>
<span><span class="co">#&gt; 2000:        2000 2012-06-11 2015-06-12</span></span></code></pre></div>
<p>Because we’ve already generated <code>y</code>
(<code>averaging_period3</code>) to contain the desired averaging
interval for each value of the grouping variable
<code>location_id</code>, it’s ready to be used as an argument to
<code>intervalaverag</code>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/intervalaverage.html">intervalaverage</a></span><span class="op">(</span><span class="va">exposure_dataset3</span>,</span>
<span>                <span class="va">averaging_periods3</span>,</span>
<span>                interval_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start"</span>,<span class="st">"end"</span><span class="op">)</span>,</span>
<span>                value_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pm25"</span>,<span class="st">"no2"</span><span class="op">)</span>,</span>
<span>                group_vars<span class="op">=</span><span class="st">"location_id"</span><span class="op">)</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">location_id</span>,<span class="va">start</span>,<span class="va">end</span>,<span class="va">pm25</span>,<span class="va">no2</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt;       location_id      start        end     pm25      no2</span></span>
<span><span class="co">#&gt;    1:           1 2006-12-11 2009-12-11 14.92398 25.08483</span></span>
<span><span class="co">#&gt;    2:           2 2018-02-17 2021-02-17       NA       NA</span></span>
<span><span class="co">#&gt;    3:           3 2019-12-23 2022-12-23       NA       NA</span></span>
<span><span class="co">#&gt;    4:           4 2019-01-08 2022-01-08       NA       NA</span></span>
<span><span class="co">#&gt;    5:           5 2017-03-16 2020-03-16       NA       NA</span></span>
<span><span class="co">#&gt;   ---                                                    </span></span>
<span><span class="co">#&gt; 1996:        1996 2012-09-19 2015-09-20 15.02879 25.05804</span></span>
<span><span class="co">#&gt; 1997:        1997 2003-04-09 2006-04-09 14.88153 24.99050</span></span>
<span><span class="co">#&gt; 1998:        1998 2001-03-31 2004-03-31 15.05534 24.90188</span></span>
<span><span class="co">#&gt; 1999:        1999 2016-12-11 2019-12-12       NA       NA</span></span>
<span><span class="co">#&gt; 2000:        2000 2012-06-11 2015-06-12 15.09675 25.04789</span></span></code></pre></div>
<p>You shouldn’t be surprised to see some missingness since the earliest
possible latest possible averaging period start date is Dec 31, 2019 but
the exposures stop in early 2019. The <code>required_percentage</code>
argument could be set here to something less than the default of 100 to
compute partial averages and get fewer missing values.</p>
<p>Finally, a quick trick if you’d like to calculate 1-year, 2-year, and
3-year averages all at once, starting with a fixed set of end dates:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">averaging_periods3</span><span class="op">[</span>, <span class="va">avg3yr</span><span class="op">:=</span><span class="va">end</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">3</span><span class="op">*</span><span class="fl">365.25</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">averaging_periods3</span><span class="op">[</span>, <span class="va">avg2yr</span><span class="op">:=</span><span class="va">end</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="fl">365.25</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">averaging_periods3</span><span class="op">[</span>, <span class="va">avg1yr</span><span class="op">:=</span><span class="va">end</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">1</span><span class="op">*</span><span class="fl">365.25</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#reshape the data.table:</span></span>
<span><span class="va">averaging_periods4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">averaging_periods3</span>,id.vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"location_id"</span>,<span class="st">"end"</span><span class="op">)</span>,</span>
<span>                           measure.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"avg3yr"</span>,<span class="st">"avg2yr"</span>,<span class="st">"avg1yr"</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">averaging_periods4</span>, <span class="st">"value"</span>,<span class="st">"start"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">averaging_periods4</span>, <span class="st">"variable"</span>,<span class="st">"averaging_period"</span><span class="op">)</span></span>
<span><span class="va">averaging_periods4</span></span>
<span><span class="co">#&gt;       location_id        end averaging_period      start</span></span>
<span><span class="co">#&gt;    1:           1 2009-12-11           avg3yr 2006-12-11</span></span>
<span><span class="co">#&gt;    2:           2 2021-02-17           avg3yr 2018-02-17</span></span>
<span><span class="co">#&gt;    3:           3 2022-12-23           avg3yr 2019-12-23</span></span>
<span><span class="co">#&gt;    4:           4 2022-01-08           avg3yr 2019-01-08</span></span>
<span><span class="co">#&gt;    5:           5 2020-03-16           avg3yr 2017-03-16</span></span>
<span><span class="co">#&gt;   ---                                                   </span></span>
<span><span class="co">#&gt; 5996:        1996 2015-09-20           avg1yr 2014-09-20</span></span>
<span><span class="co">#&gt; 5997:        1997 2006-04-09           avg1yr 2005-04-09</span></span>
<span><span class="co">#&gt; 5998:        1998 2004-03-31           avg1yr 2003-04-01</span></span>
<span><span class="co">#&gt; 5999:        1999 2019-12-12           avg1yr 2018-12-12</span></span>
<span><span class="co">#&gt; 6000:        2000 2015-06-12           avg1yr 2014-06-12</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="../reference/intervalaverage.html">intervalaverage</a></span><span class="op">(</span><span class="va">exposure_dataset3</span>,<span class="va">averaging_periods4</span>,interval_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start"</span>,<span class="st">"end"</span><span class="op">)</span>,</span>
<span>                value_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pm25"</span>,<span class="st">"no2"</span><span class="op">)</span>,</span>
<span>                group_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"location_id"</span><span class="op">)</span>,</span>
<span>                required_percentage <span class="op">=</span> <span class="fl">75</span><span class="op">)</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">location_id</span>,<span class="va">start</span>,<span class="va">end</span>,<span class="va">pm25</span>,<span class="va">no2</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt;       location_id      start        end     pm25      no2</span></span>
<span><span class="co">#&gt;    1:           1 2006-12-11 2009-12-11 14.92398 25.08483</span></span>
<span><span class="co">#&gt;    2:           1 2007-12-12 2009-12-11 14.96129 25.01816</span></span>
<span><span class="co">#&gt;    3:           1 2008-12-11 2009-12-11 14.99041 25.02960</span></span>
<span><span class="co">#&gt;    4:           2 2018-02-17 2021-02-17       NA       NA</span></span>
<span><span class="co">#&gt;    5:           2 2019-02-18 2021-02-17       NA       NA</span></span>
<span><span class="co">#&gt;   ---                                                    </span></span>
<span><span class="co">#&gt; 5996:        1999 2017-12-12 2019-12-12       NA       NA</span></span>
<span><span class="co">#&gt; 5997:        1999 2018-12-12 2019-12-12       NA       NA</span></span>
<span><span class="co">#&gt; 5998:        2000 2012-06-11 2015-06-12 15.09675 25.04789</span></span>
<span><span class="co">#&gt; 5999:        2000 2013-06-12 2015-06-12 15.07803 25.03959</span></span>
<span><span class="co">#&gt; 6000:        2000 2014-06-12 2015-06-12 14.95297 25.14248</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="interval-intersects-averaging-with-an-address-history">Interval intersects: averaging with an address history<a class="anchor" aria-label="anchor" href="#interval-intersects-averaging-with-an-address-history"></a>
</h2>
<p>So far we’ve fully covered the functionality of the
<code>intervalaverage</code> function and how to use it when we want to
average over time at specific locations.</p>
<p>The above examples also cover the approach we’d use if we wanted to
average over a cohort of study participants for whom we only have a
single address (and we are ok assuming that participants never
move).</p>
<p>However, in cohort studies, each participants shares their past
locations/addresses and indicated the time periods over which they lived
at each of those addresses. Typically this information is represented
through a table we refer to as an “address history.”</p>
<p>We’ll start with a very simple example to demonstrate what an address
history looks like and how we might use this in exposure averaging.
Consider the following address history and exposure datasets:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exposure_dataset5</span></span>
<span><span class="co">#&gt;     addr_id exp_start exp_end  exp_value</span></span>
<span><span class="co">#&gt;  1:       1         1       7  1.3345175</span></span>
<span><span class="co">#&gt;  2:       1         8      14  1.0233578</span></span>
<span><span class="co">#&gt;  3:       1        15      21  1.0334900</span></span>
<span><span class="co">#&gt;  4:       2         1       7 -1.3967607</span></span>
<span><span class="co">#&gt;  5:       2         8      14  1.2922388</span></span>
<span><span class="co">#&gt;  6:       2        15      21 -1.3653823</span></span>
<span><span class="co">#&gt;  7:       3         1       7 -0.9738918</span></span>
<span><span class="co">#&gt;  8:       3         8      14  0.9785869</span></span>
<span><span class="co">#&gt;  9:       3        15      21 -0.2132947</span></span>
<span><span class="co">#&gt; 10:       4         1       7  0.2635925</span></span>
<span><span class="co">#&gt; 11:       4         8      14  0.2779942</span></span>
<span><span class="co">#&gt; 12:       4        15      21 -0.7184920</span></span></code></pre></div>
<p>Note that <code>exposure_dataset5</code> has two regular (length-7)
intervals for each address and corresponding measurements for those
periods.</p>
<p>Here is a sample address history table:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">address_history0</span></span>
<span><span class="co">#&gt;    addr_id ppt_id addr_start addr_end</span></span>
<span><span class="co">#&gt; 1:       1      1          1        9</span></span>
<span><span class="co">#&gt; 2:       2      1         10       11</span></span>
<span><span class="co">#&gt; 3:       2      1         12       14</span></span>
<span><span class="co">#&gt; 4:       3      2          1       12</span></span>
<span><span class="co">#&gt; 5:       5      2         13       15</span></span></code></pre></div>
<p>The first thing to note is that the address intervals
(<code>addr_start</code> and <code>addr_end</code>) are non-overlapping,
which is good because <code>intervalaverage</code> requires
non-overlapping intervals as we saw previously. (If the addresses were
overlapping we might consider using the <code>isolateoverlaps</code>
function on it to identify overlapping periods in the address history
and make decisions about which address to use in each overlapping
period).</p>
<p>The <code>address_history0</code> table has one participant with
three rows and two addresses (<code>addr_id</code>s 1 and 2). In
practice this would be the same data if the two intervals where
<code>ppt_id==1 &amp; addr_id==2</code> were stored as a single row
corresponding to the interval <code>[10,14]</code>, but the dataset has
been created like this to demonstrate that a single address represented
over non-overlapping intervals doesn’t cause problems. The second
participant also has two addresses (<code>addr_ids</code>s 3 and 5).</p>
<p>The goal here is to get exposures merged and clipped to the address
intervals, but the problem is that the address intervals don’t line up
nicely with the exposure intervals. Participant 1 lived add address 1
from <code>[1,9]</code> but exposure is measured over <code>[1,7]</code>
and <code>[8,14]</code>. The solution is to create two rows for that
participant, one row for <code>[1,7]</code> and a second row from
<code>[8,9]</code>. This can be accomplished using the
<code>intervalintersect</code> function:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">exposure_addresss_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/intervalintersect.html">intervalintersect</a></span><span class="op">(</span><span class="va">exposure_dataset5</span>,</span>
<span>                                             <span class="va">address_history0</span>,</span>
<span>                                             interval_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>exp_start<span class="op">=</span><span class="st">"addr_start"</span>,</span>
<span>                                                             exp_end<span class="op">=</span><span class="st">"addr_end"</span><span class="op">)</span>,</span>
<span>                                             <span class="st">"addr_id"</span><span class="op">)</span></span>
<span><span class="va">exposure_addresss_table</span></span>
<span><span class="co">#&gt;    addr_id start end  exp_value ppt_id</span></span>
<span><span class="co">#&gt; 1:       1     1   7  1.3345175      1</span></span>
<span><span class="co">#&gt; 2:       1     8   9  1.0233578      1</span></span>
<span><span class="co">#&gt; 3:       2    10  11  1.2922388      1</span></span>
<span><span class="co">#&gt; 4:       2    12  14  1.2922388      1</span></span>
<span><span class="co">#&gt; 5:       3     1   7 -0.9738918      2</span></span>
<span><span class="co">#&gt; 6:       3     8  12  0.9785869      2</span></span></code></pre></div>
<p><code>intervalintersect</code> takes every possible combination of
overlapping intervals within <code>group_vars</code> (in this sense it
is a cartesian join. More on this below).</p>
<p><code>intervalintersect</code> is also an inner join because rows
from either table that are not joined are not included in the output.
For example, rows where <code>addr_id==4</code> in
<code>exposure_dataset5</code> is not included since there are no rows
in <code>address_history0</code> where <code>addr_id==4</code>.
Additionally, none of the exposure periods from
<code>exposure_dataset5</code> measured over
<code>exposure_start==15</code> to <code>exposure_start==21</code> are
included in the result, because none of the address history intervals
overlap with those periods. Finally, there is an address
(<code>addr_id==5</code> from <code>ppt_id==2</code>) in the
<code>addr_history</code> table that isn’t in the
<code>exposure_dataset5</code> table. This address is also excluded from
the result since exposure estimates do not exist for that
participant.</p>
<p>It’s worth doing some checks after completion of the intersection to
identify what information has been dropped by the inner join:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">address_history0</span><span class="op">$</span><span class="va">addr_id</span>,<span class="va">exposure_addresss_table</span><span class="op">$</span><span class="va">addr_id</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">exposure_dataset5</span><span class="op">$</span><span class="va">addr_id</span>,<span class="va">exposure_addresss_table</span><span class="op">$</span><span class="va">addr_id</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 4</span></span></code></pre></div>
<p>Finally, note that the syntax of <code>interval_vars</code> allows
those columns to be named differently in <code>x</code> and
<code>y</code> via a named vector:
<code>interval_vars=c(exposure_start="addr_start",exposure_end="addr_end")</code>.
This is useful for keeping track of interval names since the return
data.table has three sets of intervals: those from <code>x</code>, those
from <code>y</code>, and their intersections.</p>
<div class="section level3">
<h3 id="interval-intersects-averaging-with-a-larger-address-history">Interval intersects: averaging with a larger address history<a class="anchor" aria-label="anchor" href="#interval-intersects-averaging-with-a-larger-address-history"></a>
</h3>
<p>starting with the unique set of locations extracted from
<code>exposure_dataset3</code>, let’s generate 300 participants and a
random number of addresses each participant lived at</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_ppt</span> <span class="op">&lt;-</span> <span class="fl">300</span></span>
<span><span class="va">addr_history</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>ppt_id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"ppt"</span>,<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%03d"</span>, <span class="fl">1</span><span class="op">:</span><span class="va">n_ppt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">addr_history</span><span class="op">[</span>, <span class="va">n_addr</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">.N</span>,size<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">exposure_dataset3</span><span class="op">$</span><span class="va">location_id</span><span class="op">)</span><span class="op">)</span>,prob<span class="op">=</span><span class="fl">.001</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">addr_history</span><span class="op">[</span><span class="va">n_addr</span> <span class="op">&lt;</span><span class="fl">1L</span>, <span class="va">n_addr</span> <span class="op">:=</span> <span class="fl">1L</span><span class="op">]</span> </span>
<span></span>
<span><span class="co">#repl=TRUE because it's possible for an address to be lived at multiple different time intervals:</span></span>
<span><span class="va">addr_history</span> <span class="op">&lt;-</span> <span class="va">addr_history</span><span class="op">[</span>, </span>
<span>                             <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>location_id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">exposure_dataset3</span><span class="op">$</span><span class="va">location_id</span>,<span class="va">n_addr</span>,replace<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                             by<span class="op">=</span><span class="st">"ppt_id"</span></span>
<span>                             <span class="op">]</span>   </span>
<span><span class="va">addr_history</span></span>
<span><span class="co">#&gt;      ppt_id location_id</span></span>
<span><span class="co">#&gt;   1: ppt001        1793</span></span>
<span><span class="co">#&gt;   2: ppt001         337</span></span>
<span><span class="co">#&gt;   3: ppt002        1492</span></span>
<span><span class="co">#&gt;   4: ppt002        1943</span></span>
<span><span class="co">#&gt;   5: ppt002        1853</span></span>
<span><span class="co">#&gt;  ---                   </span></span>
<span><span class="co">#&gt; 616: ppt299        1047</span></span>
<span><span class="co">#&gt; 617: ppt299         878</span></span>
<span><span class="co">#&gt; 618: ppt300        1228</span></span>
<span><span class="co">#&gt; 619: ppt300        1194</span></span>
<span><span class="co">#&gt; 620: ppt300         241</span></span>
<span></span>
<span><span class="co">#note that not all of these 2000 locations in exposure_dataset3 were "lived at" in this cohort:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">addr_history</span><span class="op">$</span><span class="va">location_id</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="co">#&gt; [1] 535</span></span>
<span></span>
<span><span class="co">#also note that it's possible for different participants to live at the same address.</span></span>
<span><span class="va">addr_history</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>loc_with_more_than_one_ppt<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">ppt_id</span><span class="op">)</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>             by<span class="op">=</span><span class="va">location_id</span><span class="op">]</span><span class="op">[</span>,</span>
<span>                             <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">loc_with_more_than_one_ppt</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 77</span></span>
<span><span class="co">#Because of the way I generated this data, it's way more common than you'd expect in a real cohort </span></span>
<span><span class="co">#but it does happen especially in cohorts with familial recruitment or people living in nursing home complexes.</span></span></code></pre></div>
<p>I’ve generated intervals which are non-overlapping representing the
participant address history (the code to achieve this is hidden because
it’s complicated and not the point of this vignette):</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">addr_history</span></span>
<span><span class="co">#&gt;      ppt_id location_id addr_start   addr_end  addr_id</span></span>
<span><span class="co">#&gt;   1: ppt001        1793 1961-04-01 1986-07-03 ppt001_2</span></span>
<span><span class="co">#&gt;   2: ppt001         337 1989-06-14 9999-01-01 ppt001_1</span></span>
<span><span class="co">#&gt;   3: ppt002        1492 1970-07-01 1978-04-12 ppt002_2</span></span>
<span><span class="co">#&gt;   4: ppt002        1943 1980-07-02 1981-12-07 ppt002_4</span></span>
<span><span class="co">#&gt;   5: ppt002        1853 1984-07-10 1990-08-19 ppt002_3</span></span>
<span><span class="co">#&gt;  ---                                                  </span></span>
<span><span class="co">#&gt; 616: ppt299        1047 1974-06-28 1983-01-04 ppt299_2</span></span>
<span><span class="co">#&gt; 617: ppt299         878 1988-08-05 9999-01-01 ppt299_1</span></span>
<span><span class="co">#&gt; 618: ppt300        1228 1972-09-01 1975-04-17 ppt300_3</span></span>
<span><span class="co">#&gt; 619: ppt300        1194 1975-08-27 1989-11-11 ppt300_2</span></span>
<span><span class="co">#&gt; 620: ppt300         241 2004-06-20 9999-01-01 ppt300_1</span></span></code></pre></div>
<p>Oftentimes participant addresses are given their own keys that are
distinct from location_id and that’s represented in the above table.
This means that a single <code>location_id</code> may map to multiple
<code>addr_ids</code>.</p>
<p>It’s important for these address tables to be non-overlapping within
ppt. As shown previously, there’s a function in the
<code>intervalaverage</code> package for that check:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/is.overlapping.html">is.overlapping</a></span><span class="op">(</span><span class="va">addr_history</span>,interval_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"addr_start"</span>,<span class="st">"addr_end"</span><span class="op">)</span>,</span>
<span>               group_vars<span class="op">=</span><span class="st">"ppt_id"</span><span class="op">)</span> <span class="co">#FALSE is good--it means there's no overlap of dates within ppt.</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>This table passes that check because I’ve generated the data to be
non-overlapping, but often times people report overlapping address
histories and analytic decisions need to be made to de-overlap them
(again, the <code>isolateoverlap</code> function would be useful for
isolating sections of overlapping address intervals).</p>
</div>
<div class="section level3">
<h3 id="interval-intersects-is-a-cartesian-join">interval intersects is a cartesian join<a class="anchor" aria-label="anchor" href="#interval-intersects-is-a-cartesian-join"></a>
</h3>
<p>So far we’ve seen exposure datasets stored by
<code>location_id</code> but it’s possible also to store exposures
stored by <code>addr_id</code> (such that the series of exposure
estimates for a single locations may be repeated multiple time if that
<code>location_id</code> maps to multiple <code>addr_id</code>s )</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exposure_dataset3_addr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">addr_history</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">location_id</span>,<span class="va">addr_id</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="va">exposure_dataset3</span>, </span>
<span>                                                                            on<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"location_id"</span><span class="op">)</span>,</span>
<span>                                                                            allow.cartesian<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                                                                            nomatch<span class="op">=</span><span class="cn">NULL</span><span class="op">]</span></span>
<span><span class="va">exposure_dataset3</span></span>
<span><span class="co">#&gt;          location_id      start        end     pm25      no2</span></span>
<span><span class="co">#&gt;       1:           1 2000-01-01 2000-01-07 14.63278 26.21289</span></span>
<span><span class="co">#&gt;       2:           1 2000-01-08 2000-01-14 13.95587 24.37274</span></span>
<span><span class="co">#&gt;       3:           1 2000-01-15 2000-01-21 15.56972 26.71116</span></span>
<span><span class="co">#&gt;       4:           1 2000-01-22 2000-01-28 14.86495 24.60563</span></span>
<span><span class="co">#&gt;       5:           1 2000-01-29 2000-02-04 17.40162 22.67851</span></span>
<span><span class="co">#&gt;      ---                                                    </span></span>
<span><span class="co">#&gt; 1999996:        2000 2019-01-26 2019-02-01 15.00646 25.27885</span></span>
<span><span class="co">#&gt; 1999997:        2000 2019-02-02 2019-02-08 16.41525 26.14573</span></span>
<span><span class="co">#&gt; 1999998:        2000 2019-02-09 2019-02-15 15.29644 24.84448</span></span>
<span><span class="co">#&gt; 1999999:        2000 2019-02-16 2019-02-22 15.05604 24.01209</span></span>
<span><span class="co">#&gt; 2000000:        2000 2019-02-23 2019-03-01 17.37829 26.74711</span></span>
<span><span class="va">exposure_dataset3_addr</span></span>
<span><span class="co">#&gt;         location_id  addr_id      start        end     pm25      no2</span></span>
<span><span class="co">#&gt;      1:           1 ppt105_1 2000-01-01 2000-01-07 14.63278 26.21289</span></span>
<span><span class="co">#&gt;      2:           1 ppt105_1 2000-01-08 2000-01-14 13.95587 24.37274</span></span>
<span><span class="co">#&gt;      3:           1 ppt105_1 2000-01-15 2000-01-21 15.56972 26.71116</span></span>
<span><span class="co">#&gt;      4:           1 ppt105_1 2000-01-22 2000-01-28 14.86495 24.60563</span></span>
<span><span class="co">#&gt;      5:           1 ppt105_1 2000-01-29 2000-02-04 17.40162 22.67851</span></span>
<span><span class="co">#&gt;     ---                                                             </span></span>
<span><span class="co">#&gt; 619996:        1997 ppt150_1 2019-02-09 2019-02-15 14.45723 25.47479</span></span>
<span><span class="co">#&gt; 619997:        1997 ppt054_2 2019-02-16 2019-02-22 14.05648 26.26435</span></span>
<span><span class="co">#&gt; 619998:        1997 ppt150_1 2019-02-16 2019-02-22 14.05648 26.26435</span></span>
<span><span class="co">#&gt; 619999:        1997 ppt054_2 2019-02-23 2019-03-01 15.54294 22.57325</span></span>
<span><span class="co">#&gt; 620000:        1997 ppt150_1 2019-02-23 2019-03-01 15.54294 22.57325</span></span></code></pre></div>
<p>Note that <code>exposure_dataset3_addr</code> contains repeat
locations whereas <code>exposure_dataset3</code> contains exactly one
location per time point:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exposure_dataset3</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">location_id</span><span class="op">)</span><span class="op">)</span>,by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start"</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">V1</span><span class="op">)</span><span class="op">]</span> <span class="co">#no duplicate locations at any date</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="va">exposure_dataset3_addr</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">location_id</span><span class="op">)</span><span class="op">)</span>,by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start"</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">V1</span><span class="op">)</span><span class="op">]</span> </span>
<span><span class="co">#&gt; [1] 85</span></span></code></pre></div>
<p><code>exposure_dataset3_addr</code> has duplicate locations since
multiple ppts may live at the same location or because a single
participant lives at the same location multiple times.</p>
<p>(Storing exposure data according to <code>addr_id</code> rather than
<code>location_id</code> takes up more space but may be beneficial for
constraining exposure model revisions to be the same within cohorts)</p>
<p><code>location_id</code> may not even be present in the address table
if it’s stored by address_id:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exposure_dataset3_addr</span><span class="op">[</span>, <span class="va">location_id</span><span class="op">:=</span><span class="cn">NULL</span><span class="op">]</span></span></code></pre></div>
<p>Even if this distinction between how exposures are stored doesn’t
seem relevant, this section will demonstrate how
<code>intervalintersect</code> is actually a cartesian join (in addition
to being an inner interval join).</p>
<p>Whether the exposure dataset is stored by address or location, the
<code>intervalintersect</code> will result in values from the exposure
dataset merged to every address. In the case of the exposure table being
stored by <code>addr_id</code>, this is a simple one to one merge (since
for every address in the address history there’s a set of exposures in
the exposure table).</p>
<p>But in the case of the exposure table being stored by
<code>location_id</code>, this becomes a one to many merge (since a
single location id may merge to multiple locations in the address
history table).</p>
<p>This works because the function that <code>intervalintersect</code>
relies on (<code><a href="https://Rdatatable.gitlab.io/data.table/reference/foverlaps.html" class="external-link">data.table::foverlaps</a></code>) is performing an inner
cartesian merge: that is–it only takes rows which match on the keying
variables but also does a cartesian expansion if there are multiple
matches in both tables.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/intervalintersect.html">intervalintersect</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">exposure_dataset3</span>,</span>
<span>               y<span class="op">=</span><span class="va">addr_history</span>,</span>
<span>               interval_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>                 start<span class="op">=</span><span class="st">"addr_start"</span>,</span>
<span>                 end<span class="op">=</span><span class="st">"addr_end"</span></span>
<span>                 <span class="op">)</span>,</span>
<span>               group_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"location_id"</span><span class="op">)</span>,</span>
<span>               interval_vars_out<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start2"</span>,<span class="st">"end2"</span><span class="op">)</span></span>
<span><span class="op">)</span> </span>
<span></span>
<span><span class="va">z_addr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/intervalintersect.html">intervalintersect</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">exposure_dataset3_addr</span>,</span>
<span>               y<span class="op">=</span><span class="va">addr_history</span>,</span>
<span>               interval_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>                 start<span class="op">=</span><span class="st">"addr_start"</span>,</span>
<span>                 end<span class="op">=</span><span class="st">"addr_end"</span></span>
<span>                 <span class="op">)</span>,</span>
<span>               group_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"addr_id"</span><span class="op">)</span>,</span>
<span>               interval_vars_out<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start2"</span>,<span class="st">"end2"</span><span class="op">)</span></span>
<span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setkey</a></span><span class="op">(</span><span class="va">z</span>,<span class="va">ppt_id</span>,<span class="va">start2</span>,<span class="va">end2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setkey</a></span><span class="op">(</span><span class="va">z_addr</span>,<span class="va">ppt_id</span>,<span class="va">start2</span>,<span class="va">end2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">z</span>,<span class="va">z_addr</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Different column order"</span></span>
<span></span>
<span><span class="va">z</span></span>
<span><span class="co">#&gt;         location_id     start2       end2     pm25      no2 ppt_id  addr_id</span></span>
<span><span class="co">#&gt;      1:         337 2000-01-01 2000-01-07 15.15344 26.26791 ppt001 ppt001_1</span></span>
<span><span class="co">#&gt;      2:         337 2000-01-08 2000-01-14 13.68185 23.93172 ppt001 ppt001_1</span></span>
<span><span class="co">#&gt;      3:         337 2000-01-15 2000-01-21 13.06989 24.23879 ppt001 ppt001_1</span></span>
<span><span class="co">#&gt;      4:         337 2000-01-22 2000-01-28 15.90837 26.32763 ppt001 ppt001_1</span></span>
<span><span class="co">#&gt;      5:         337 2000-01-29 2000-02-04 15.50739 24.37651 ppt001 ppt001_1</span></span>
<span><span class="co">#&gt;     ---                                                                    </span></span>
<span><span class="co">#&gt; 264965:         241 2019-01-26 2019-02-01 14.57620 25.32593 ppt300 ppt300_1</span></span>
<span><span class="co">#&gt; 264966:         241 2019-02-02 2019-02-08 14.78497 26.70319 ppt300 ppt300_1</span></span>
<span><span class="co">#&gt; 264967:         241 2019-02-09 2019-02-15 14.55443 24.04428 ppt300 ppt300_1</span></span>
<span><span class="co">#&gt; 264968:         241 2019-02-16 2019-02-22 14.07411 26.19916 ppt300 ppt300_1</span></span>
<span><span class="co">#&gt; 264969:         241 2019-02-23 2019-03-01 13.29841 25.35809 ppt300 ppt300_1</span></span></code></pre></div>
<p>(note that this example of a one to many join maybe isn’t a true
“cartesian” join, but intervalintersect is capable of doing a true
many-to-many cartesian expansion if provided the right datasets,
although I’m not sure in context that would actually make any
sense.)</p>
<p>In any case, the morale here is that whether the exposures are stored
by location or address, using <code>intervalintersect</code> in
combination will result in a dataset containing relevant exposures
clipped to each address period.</p>
<p>This dataset can then be used to calculate averages over where a
participant lived in a given period:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">final_averaging_periods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>ppt_id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">addr_history</span><span class="op">$</span><span class="va">ppt_id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">final_averaging_periods</span><span class="op">[</span>, <span class="va">end2</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="st">"2003-01-01"</span><span class="op">)</span>,<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="st">"2015-01-01"</span><span class="op">)</span>,by<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,<span class="va">.N</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">final_averaging_periods</span><span class="op">[</span>,<span class="va">start2</span><span class="op">:=</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">end2</span><span class="op">-</span><span class="fl">3</span><span class="op">*</span><span class="fl">365.25</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">final_averaging_periods</span></span>
<span><span class="co">#&gt;      ppt_id       end2     start2</span></span>
<span><span class="co">#&gt;   1: ppt001 2011-12-22 2008-12-21</span></span>
<span><span class="co">#&gt;   2: ppt002 2004-12-28 2001-12-28</span></span>
<span><span class="co">#&gt;   3: ppt003 2008-02-24 2005-02-23</span></span>
<span><span class="co">#&gt;   4: ppt004 2010-09-17 2007-09-17</span></span>
<span><span class="co">#&gt;   5: ppt005 2010-03-18 2007-03-18</span></span>
<span><span class="co">#&gt;  ---                             </span></span>
<span><span class="co">#&gt; 296: ppt296 2013-01-14 2010-01-14</span></span>
<span><span class="co">#&gt; 297: ppt297 2004-05-14 2001-05-14</span></span>
<span><span class="co">#&gt; 298: ppt298 2009-10-27 2006-10-27</span></span>
<span><span class="co">#&gt; 299: ppt299 2004-08-07 2001-08-07</span></span>
<span><span class="co">#&gt; 300: ppt300 2006-05-14 2003-05-14</span></span>
<span></span>
<span><span class="fu"><a href="../reference/intervalaverage.html">intervalaverage</a></span><span class="op">(</span><span class="va">z</span>,<span class="va">final_averaging_periods</span>, interval_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start2"</span>,<span class="st">"end2"</span><span class="op">)</span>,</span>
<span>                value_vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pm25"</span>,<span class="st">"no2"</span><span class="op">)</span>,group_vars<span class="op">=</span><span class="st">"ppt_id"</span>,required_percentage <span class="op">=</span> <span class="fl">95</span></span>
<span>                <span class="op">)</span></span>
<span><span class="co">#&gt;      ppt_id     start2       end2     pm25      no2 yduration xduration</span></span>
<span><span class="co">#&gt;   1: ppt001 2008-12-21 2011-12-22 15.10230 24.95967      1097      1097</span></span>
<span><span class="co">#&gt;   2: ppt002 2001-12-28 2004-12-28 14.95920 24.96800      1097      1097</span></span>
<span><span class="co">#&gt;   3: ppt003 2005-02-23 2008-02-24 14.87310 25.03825      1097      1097</span></span>
<span><span class="co">#&gt;   4: ppt004 2007-09-17 2010-09-17 14.92221 24.96349      1097      1097</span></span>
<span><span class="co">#&gt;   5: ppt005 2007-03-18 2010-03-18 14.97623 24.93725      1097      1097</span></span>
<span><span class="co">#&gt;  ---                                                                   </span></span>
<span><span class="co">#&gt; 296: ppt296 2010-01-14 2013-01-14       NA       NA      1097         0</span></span>
<span><span class="co">#&gt; 297: ppt297 2001-05-14 2004-05-14 15.09852 24.93369      1097      1097</span></span>
<span><span class="co">#&gt; 298: ppt298 2006-10-27 2009-10-27       NA       NA      1097       552</span></span>
<span><span class="co">#&gt; 299: ppt299 2001-08-07 2004-08-07 15.11682 25.05562      1097      1097</span></span>
<span><span class="co">#&gt; 300: ppt300 2003-05-14 2006-05-14       NA       NA      1097       694</span></span>
<span><span class="co">#&gt;      nobs_pm25 nobs_no2  xminstart    xmaxend maxgap_pm25 maxgap_no2</span></span>
<span><span class="co">#&gt;   1:      1097     1097 2008-12-21 2011-12-22           0          0</span></span>
<span><span class="co">#&gt;   2:      1097     1097 2001-12-28 2004-12-28           0          0</span></span>
<span><span class="co">#&gt;   3:      1097     1097 2005-02-23 2008-02-24           0          0</span></span>
<span><span class="co">#&gt;   4:      1097     1097 2007-09-17 2010-09-17           0          0</span></span>
<span><span class="co">#&gt;   5:      1097     1097 2007-03-18 2010-03-18           0          0</span></span>
<span><span class="co">#&gt;  ---                                                                </span></span>
<span><span class="co">#&gt; 296:         0        0       &lt;NA&gt;       &lt;NA&gt;        1097       1097</span></span>
<span><span class="co">#&gt; 297:      1097     1097 2001-05-14 2004-05-14           0          0</span></span>
<span><span class="co">#&gt; 298:       552      552 2008-04-24 2009-10-27         545        545</span></span>
<span><span class="co">#&gt; 299:      1097     1097 2001-08-07 2004-08-07           0          0</span></span>
<span><span class="co">#&gt; 300:       694      694 2004-06-20 2006-05-14         403        403</span></span></code></pre></div>
<p>There’s lots of missingness because the address history I generated
is nowhere near complete, but this demonstrates how important it is to
have a good address history!</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Michael Young.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
