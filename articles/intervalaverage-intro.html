<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to `intervalaverage` • intervalaverage</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to `intervalaverage`">
<meta property="og:description" content="intervalaverage">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">intervalaverage</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.9.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intervalaverage-advanced.html">Introduction to intervalaverage</a>
    </li>
    <li>
      <a href="../articles/intervalaverage-intro.html">Introduction to `intervalaverage`</a>
    </li>
    <li>
      <a href="../articles/intervalaverage-technicaloverview.html">Technical overview of the intervalaverage function</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to <code>intervalaverage</code>
</h1>
            
            <h4 data-toc-skip class="date">2022-06-10</h4>
      
      
      <div class="hidden name"><code>intervalaverage-intro.Rmd</code></div>

    </div>

    
    
<p><em>Note: This package and vignette makes extensive use of <code>data.table</code>. If you’re unfamiliar with the <code>data.table</code> syntax, a brief review of that package’s <a href="https://cran.r-project.org/web/packages/data.table/vignettes/datatable-intro.html" class="external-link">introductory vignette</a> may be useful.</em></p>
<div class="section level2">
<h2 id="what-does-intervalaverage-do">What does <code>intervalaverage</code> do?<a class="anchor" aria-label="anchor" href="#what-does-intervalaverage-do"></a>
</h2>
<p>The <code>intervalaverage</code> package is intended to do a specific job very efficiently. Namely, it averages data measured non-continuously over arbitrary intervals. It is implemented in C++ and <code>data.table</code> in order to do this job as fast and in as memory-efficient a way as possible.</p>
<p>The motivation for this package was to efficiently create time- and location-weighted averages of air pollution exposure for participants in epidemiological studies. In these studies, air pollution exposure is modeled on a weekly, monthly, or annual basis for study participants’ home addresses. In order to create a long-term average of each study participant’s air pollution exposure, it is necessary to calculate an average of the modeled exposures for each address for the period during which they lived there, which may not align nicely with the exposure periods produced by the models.</p>
<p>There are likely many other applications for averaging non-continuous measurements over arbitrary intervals, but this documentation will demonstrate the application of calculating long-term air pollution exposures for individuals over multiple locations.</p>
</div>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>We will use two data sets (included in this package) to demonstrate <code>intervalaverage</code>’s main functionality.</p>
<ul>
<li><p><code>no2</code> Nitrogen Dioxide (NO<sub>2</sub>) modeled annually at 62 home addresses (identified by <code>location_id</code>)</p></li>
<li><p><code>address_history</code> The time periods for which 25 people (identified by <code>person_id</code>) lived at each of these home address.</p></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://kaufman-lab.github.io/intervalaverage/">intervalaverage</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"no2"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"address_history"</span><span class="op">)</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">no2</span><span class="op">)</span> 
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">address_history</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">no2</span><span class="op">[</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt;      no2 start_date   end_date location_id</span>
<span class="co">#&gt; 1: 24.05 1990-01-01 1990-12-31           1</span>
<span class="co">#&gt; 2: 22.99 1991-01-01 1991-12-31           1</span>
<span class="co">#&gt; 3: 24.90 1992-01-01 1992-12-31           1</span>
<span class="co">#&gt; 4: 25.88 1993-01-01 1993-12-31           1</span>
<span class="co">#&gt; 5: 25.99 1994-01-01 1994-12-31           1</span>
<span class="co">#&gt; 6: 25.56 1995-01-01 1995-12-31           1</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">address_history</span><span class="op">[</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt;    start_date   end_date location_id person_id</span>
<span class="co">#&gt; 1: 1989-06-01 2021-12-31          43         1</span>
<span class="co">#&gt; 2: 1989-06-01 2001-10-31          18         2</span>
<span class="co">#&gt; 3: 2001-11-01 2007-04-30          17         2</span>
<span class="co">#&gt; 4: 2007-05-01 2021-12-31          16         2</span>
<span class="co">#&gt; 5: 1989-06-01 1996-07-05          56         3</span>
<span class="co">#&gt; 6: 1989-06-01 1992-06-30           9         4</span></code></pre></div>
<p>Note that each of these data sets is already a <code>data.table</code> and the date columns are <code>IDate</code>s. However, due to a quirk in <code>data.table</code>, we need to run <code>setDT</code> on data loaded with the <code>data</code> function.</p>
</div>
<div class="section level2">
<h2 id="averaging-measurements-over-arbitrary-intervals">Averaging Measurements over Arbitrary Intervals<a class="anchor" aria-label="anchor" href="#averaging-measurements-over-arbitrary-intervals"></a>
</h2>
<p>Inspecting the <code>no2</code> data set above, we see that each location has a single NO<sub>2</sub> measurement for each calendar year. It would be simple to find the average measurement over, for example, 2002-01-01 through 2005-12-31, because that period aligns with our measurements. However, what if we wanted to find the average NO<sub>2</sub> level at each of the periods in our <code>address_history</code>? Not only does each address have a different date range to average over, but that range doesn’t align nicely with the measurements! For each address, we need to take a mean of the measurements, weighted by how much of the measurement was overlapped by the address history.</p>
<p>This is straightforward with <code>intervalaverage</code>’s <code>intervalaverage</code> function!</p>
<p>The <code>y</code> argument of <code>intervalaverage</code> tells it what date range to average for every group in the values data set (in this case, every <code>location_id</code> in <code>no2</code>). For now, we don’t care about who lived at each address, only the unique addresses and date ranges. Since some people in our address history shared homes, we begin by creating a set of unique addresses and their associated dates.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">unique_addresses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">address_history</span><span class="op">[</span> , <span class="fu">.</span><span class="op">(</span><span class="va">location_id</span>, <span class="va">start_date</span>, <span class="va">end_date</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p>Now we can use the <code>intervalaverage</code> function:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">averaged_exposures</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/intervalaverage.html">intervalaverage</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="va">no2</span>,
  y <span class="op">=</span> <span class="va">unique_addresses</span>,
  interval_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start_date"</span>, <span class="st">"end_date"</span><span class="op">)</span>,
  value_vars <span class="op">=</span> <span class="st">"no2"</span>, 
  group_vars <span class="op">=</span> <span class="st">"location_id"</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">averaged_exposures</span><span class="op">[</span> , <span class="fu">.</span><span class="op">(</span><span class="va">location_id</span>, <span class="va">start_date</span>, <span class="va">end_date</span>, <span class="va">no2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt;    location_id start_date   end_date      no2</span>
<span class="co">#&gt; 1:           1 1990-07-01 2005-06-30 24.83144</span>
<span class="co">#&gt; 2:           2 2005-07-01 2021-12-31       NA</span>
<span class="co">#&gt; 3:           6 1989-06-01 1992-09-30       NA</span>
<span class="co">#&gt; 4:           7 1989-06-01 1990-06-30       NA</span>
<span class="co">#&gt; 5:           8 1989-06-01 2021-12-31       NA</span>
<span class="co">#&gt; 6:           9 1989-06-01 1992-06-30       NA</span></code></pre></div>
<p>You’ll notice that there are many missing values. By default, <code>intervalaverage</code> returns <code>NA</code> unless the interval specified in <code>y</code> is completely covered by the values in <code>x</code>, and many of our addresses were occupied outside the time period covered by the NO<sub>2</sub> model. To relax this requirement and return a value even when not all of the interval had NO<sub>2</sub> values, use the <code>required_percentage</code> argument. For example, here we accept an average if at least 80% of the interval has values.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">averaged_exposures</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/intervalaverage.html">intervalaverage</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="va">no2</span>,
  y <span class="op">=</span> <span class="va">unique_addresses</span>,
  interval_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start_date"</span>, <span class="st">"end_date"</span><span class="op">)</span>,
  value_vars <span class="op">=</span> <span class="st">"no2"</span>, 
  group_vars <span class="op">=</span> <span class="st">"location_id"</span>, 
  required_percentage <span class="op">=</span> <span class="fl">80</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">averaged_exposures</span><span class="op">[</span> , <span class="fu">.</span><span class="op">(</span><span class="va">location_id</span>, <span class="va">start_date</span>, <span class="va">end_date</span>, <span class="va">no2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt;    location_id start_date   end_date      no2</span>
<span class="co">#&gt; 1:           1 1990-07-01 2005-06-30 24.83144</span>
<span class="co">#&gt; 2:           2 2005-07-01 2021-12-31       NA</span>
<span class="co">#&gt; 3:           6 1989-06-01 1992-09-30 21.85671</span>
<span class="co">#&gt; 4:           7 1989-06-01 1990-06-30       NA</span>
<span class="co">#&gt; 5:           8 1989-06-01 2021-12-31       NA</span>
<span class="co">#&gt; 6:           9 1989-06-01 1992-06-30 17.59011</span></code></pre></div>
<p><code>intervalaverage</code> also includes some diagnostic columns in its output that can be useful in determining why <code>NA</code>s are being returned (this is why we selected only <code>location_id</code>, <code>start_date</code>, <code>end_date</code>, and <code>no2</code> to display above). See the “Value” section of <code><a href="../reference/intervalaverage.html">help(intervalaverage)</a></code> for an explanation of what these columns mean.</p>
</div>
<div class="section level2">
<h2 id="averaging-over-an-address-history">Averaging over an Address History<a class="anchor" aria-label="anchor" href="#averaging-over-an-address-history"></a>
</h2>
<p>If you look closely at our address history, you’ll see that some locations and dates are shared among multiple <code>person_id</code>s. This makes sense, since more than one person often lives in the same house! You’ll also notice that people move (so each <code>person_id</code> may be associated with multiple <code>location_id</code>s).</p>
<p>To create an average for each person (rather than location), we’ll need to link the <code>no2</code> measurement at each location to the person who lived there at the time. Remember, multiple people might have lived at the same location at the same or different times.</p>
<p>The <code>intervalaverage</code> package does this with the <code>intervalintersect</code> function. It looks very similar to the <code>intervalaverage</code> function:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">no2_by_person</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/intervalintersect.html">intervalintersect</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="va">no2</span>, 
  y <span class="op">=</span> <span class="va">address_history</span>, 
  interval_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'start_date'</span>, <span class="st">'end_date'</span><span class="op">)</span>, 
  group_vars <span class="op">=</span> <span class="st">'location_id'</span>
<span class="op">)</span>  
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">no2_by_person</span><span class="op">)</span>
<span class="co">#&gt;    location_id      start        end   no2 person_id</span>
<span class="co">#&gt; 1:           1 1990-07-01 1990-12-31 24.05         6</span>
<span class="co">#&gt; 2:           1 1991-01-01 1991-12-31 22.99         6</span>
<span class="co">#&gt; 3:           1 1992-01-01 1992-12-31 24.90         6</span>
<span class="co">#&gt; 4:           1 1993-01-01 1993-12-31 25.88         6</span>
<span class="co">#&gt; 5:           1 1994-01-01 1994-12-31 25.99         6</span>
<span class="co">#&gt; 6:           1 1995-01-01 1995-12-31 25.56         6</span></code></pre></div>
<p>To understand what’s happening here, let’s look at person 5.</p>
<p>This person moved from location 40 to location 41 in November of 1996.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">address_history</span><span class="op">[</span><span class="va">person_id</span> <span class="op">==</span> <span class="fl">5</span><span class="op">]</span>
<span class="co">#&gt;    start_date   end_date location_id person_id</span>
<span class="co">#&gt; 1: 1989-06-01 1996-11-30          40         5</span>
<span class="co">#&gt; 2: 1996-12-01 2021-12-31          41         5</span></code></pre></div>
<p>If you look at the result of <code>intervalintersect</code>, you’ll see that person 5 has two <code>no2</code> values for 1996, and that each one is associated with the part of the year when they lived where that value applied.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">no2_by_person</span><span class="op">[</span><span class="va">person_id</span> <span class="op">==</span> <span class="fl">5</span> <span class="op">&amp;</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">year</a></span><span class="op">(</span><span class="va">start</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">1995</span><span class="op">:</span><span class="fl">1997</span><span class="op">]</span>
<span class="co">#&gt;    location_id      start        end   no2 person_id</span>
<span class="co">#&gt; 1:          40 1995-01-01 1995-12-31 44.08         5</span>
<span class="co">#&gt; 2:          40 1996-01-01 1996-11-30 37.17         5</span>
<span class="co">#&gt; 3:          41 1996-12-01 1996-12-31 28.02         5</span>
<span class="co">#&gt; 4:          41 1997-01-01 1997-12-31 25.00         5</span></code></pre></div>
<p>Now that we have a set of NO<sub>2</sub> values associated with the <code>person_id</code> rather than <code>location_id</code>, we can use <code>intervalaverage</code> to find the average for any period of time. That could be a period that is unique to each participant (for example, the full length of their address history). Or it could be consistent for all people in the data set, such as a yearly average (where each year is a time-weighted average of the places the person lived that year).</p>
<p>We will work through both, and introduce one more function along the way.</p>
<div class="section level3">
<h3 id="full-address-history-average">Full Address History Average<a class="anchor" aria-label="anchor" href="#full-address-history-average"></a>
</h3>
<p>Again, the <code>y</code> argument of <code>intervalaverage</code> tells it what date range to average for every group in the values data set (<code>x</code>). So we first need to create a <code>data.table</code> that contains the beginning and end of each person’s full address history.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">address_coverage</span> <span class="op">&lt;-</span> <span class="va">address_history</span><span class="op">[</span> , <span class="fu">.</span><span class="op">(</span><span class="va">person_id</span>, start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">start_date</span><span class="op">)</span>, end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">end_date</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">'person_id'</span><span class="op">]</span></code></pre></div>
<p><em>You may notice I’ve used <code>start</code> and <code>end</code> here rather than <code>start_date</code> and <code>end_date</code> as I did previously. This is because of a quirk of <code>intervalintersect</code> where it returns <code>start</code> and <code>end</code> as the interval column names regardless of the input names, and in the next step, the interval column names need to match. This will be fixed in future versions of the package.</em></p>
<p>Now we simply apply <code>intervalaverage</code>, again allowing for 20% missingness in <code>no2</code> values:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">no2_overall</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/intervalaverage.html">intervalaverage</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="va">no2_by_person</span>, 
  y <span class="op">=</span> <span class="va">address_coverage</span>, 
  interval_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'start'</span>, <span class="st">'end'</span><span class="op">)</span>, 
  group_vars <span class="op">=</span> <span class="st">'person_id'</span>,
  value_vars <span class="op">=</span> <span class="st">'no2'</span>,
  required_percentage <span class="op">=</span> <span class="fl">80</span>
<span class="op">)</span>  
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">no2_overall</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">person_id</span>, <span class="va">start</span>, <span class="va">end</span>, <span class="va">no2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt;    person_id      start        end      no2</span>
<span class="co">#&gt; 1:         1 1989-06-01 2021-12-31       NA</span>
<span class="co">#&gt; 2:         2 1989-06-01 2001-10-31 21.53388</span>
<span class="co">#&gt; 3:         3 1989-06-01 1996-07-05 39.81925</span>
<span class="co">#&gt; 4:         4 1989-06-01 1992-06-30 17.59011</span>
<span class="co">#&gt; 5:         5 1989-06-01 1996-11-30 42.33158</span>
<span class="co">#&gt; 6:         6 1989-06-01 1990-06-30       NA</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="annual-averages">Annual Averages<a class="anchor" aria-label="anchor" href="#annual-averages"></a>
</h3>
<p>Finally, let’s calculate annual (calendar-year) averages for 2000-2004. We’ll need to build a <code>y</code> argument for the <code>intervalaverage</code> function that has a start date, end date for each year. However, we <em>also</em> need to repeat each year once for every participant, because <code>y</code> must contain the same grouping variable(s) as <code>x</code>.</p>
<p>This gives us an opportunity to try a convenient helper function in <code>intervalaverage</code>: <code>CJ.dt</code>. This is a more convenient version of <code><a href="https://Rdatatable.gitlab.io/data.table/reference/J.html" class="external-link">data.table::CJ</a></code> (<code>CJ</code> as in “Cross Join”) that can take <code>data.tables</code> as arguments instead of just vectors. By cross joining our unique <code>person_id</code>s with the years 2000-2004, we can construct a <code>y</code> argument that will work in the <code>intervalaverage</code> function.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Build a data.table with start and end dates for each year</span>
<span class="va">years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2000</span><span class="op">:</span><span class="fl">2004</span><span class="op">)</span> 
<span class="va">years</span><span class="op">[</span> , <span class="va">start</span> <span class="op">:=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">year</span>, <span class="st">"01"</span>, <span class="st">"01"</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
<span class="va">years</span><span class="op">[</span> ,   <span class="va">end</span> <span class="op">:=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">year</span>, <span class="st">"12"</span>, <span class="st">"31"</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
<span class="va">years</span><span class="op">[</span><span class="op">]</span>
<span class="co">#&gt;    year      start        end</span>
<span class="co">#&gt; 1: 2000 2000-01-01 2000-12-31</span>
<span class="co">#&gt; 2: 2001 2001-01-01 2001-12-31</span>
<span class="co">#&gt; 3: 2002 2002-01-01 2002-12-31</span>
<span class="co">#&gt; 4: 2003 2003-01-01 2003-12-31</span>
<span class="co">#&gt; 5: 2004 2004-01-01 2004-12-31</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Cross join with the unique person_ids in our data</span>
<span class="va">years</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CJ.dt.html">CJ.dt</a></span><span class="op">(</span><span class="va">years</span>, <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">address_history</span><span class="op">[</span> , <span class="fu">.</span><span class="op">(</span><span class="va">person_id</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">years</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">order</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">person_id</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt;    year      start        end person_id</span>
<span class="co">#&gt; 1: 2000 2000-01-01 2000-12-31         1</span>
<span class="co">#&gt; 2: 2000 2000-01-01 2000-12-31         2</span>
<span class="co">#&gt; 3: 2000 2000-01-01 2000-12-31         3</span>
<span class="co">#&gt; 4: 2000 2000-01-01 2000-12-31         4</span>
<span class="co">#&gt; 5: 2000 2000-01-01 2000-12-31         5</span>
<span class="co">#&gt; 6: 2000 2000-01-01 2000-12-31         6</span></code></pre></div>
<p>Now we can apply the <code>intervalaverage</code> function again to get a yearly average for each person. Recall that the NO<sub>2</sub> data is also annual, so the only rows that will actually be averaged will be those for years where a person moved (since a person will have had an NO<sub>2</sub> value for each address they lived in that year).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">no2_annual</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/intervalaverage.html">intervalaverage</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="va">no2_by_person</span>, 
  y <span class="op">=</span> <span class="va">years</span>, 
  interval_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'start'</span>, <span class="st">'end'</span><span class="op">)</span>, 
  group_vars <span class="op">=</span> <span class="st">'person_id'</span>,
  value_vars <span class="op">=</span> <span class="st">'no2'</span>,
  required_percentage <span class="op">=</span> <span class="fl">80</span>
<span class="op">)</span>  
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">no2_annual</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">person_id</span>, <span class="va">start</span>, <span class="va">end</span>, <span class="va">no2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt;    person_id      start        end   no2</span>
<span class="co">#&gt; 1:         1 2000-01-01 2000-12-31 35.14</span>
<span class="co">#&gt; 2:         1 2001-01-01 2001-12-31 40.35</span>
<span class="co">#&gt; 3:         1 2002-01-01 2002-12-31 32.97</span>
<span class="co">#&gt; 4:         1 2003-01-01 2003-12-31 31.82</span>
<span class="co">#&gt; 5:         1 2004-01-01 2004-12-31 30.72</span>
<span class="co">#&gt; 6:         2 2000-01-01 2000-12-31 17.13</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="further-reading">Further Reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<p>For a more detailed and advanced tutorial of how to use the <code>intervalaverage</code> package, see <code><a href="../articles/intervalaverage-advanced.html">vignette("intervalaverage-advanced")</a></code>.</p>
<p>For information about the inner workings of the package (intended for maintainers), see <code><a href="../articles/intervalaverage-technicaloverview.html">vignette("intervalaverage-technicaloverview")</a></code>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Michael Young.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
