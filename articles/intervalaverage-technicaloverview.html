<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Technical overview of the intervalaverage function • intervalaverage</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Technical overview of the intervalaverage function">
<meta property="og:description" content="intervalaverage">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">intervalaverage</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.9.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intervalaverage-advanced.html">Advanced Introduction to intervalaverage</a>
    </li>
    <li>
      <a href="../articles/intervalaverage-intro.html">Quick Introduction to intervalaverage</a>
    </li>
    <li>
      <a href="../articles/intervalaverage-technicaloverview.html">Technical overview of the intervalaverage function</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Technical overview of the intervalaverage
function</h1>
            
            <h4 data-toc-skip class="date">2023-01-20</h4>
      
      
      <div class="hidden name"><code>intervalaverage-technicaloverview.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="motivation">Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h2>
<p>The interval average function was born out of the need to take values
measured over a set of intervals and time-weight average those values
into a different set of intervals. Algorithmically, the simplest
approach to deal with this problem is just to expand interval data into
repeated values over intervals that are all the same length (e.g. the
value of <code>8</code> measured over the interval <code>[3,5]</code>
becomes the value of 8 measured over <code>[3,3]</code> and
<code>[4,4]</code> and <code>[5,5]</code>) but this is incredibly memory
intensive. Instead a weighting approach is necessary.</p>
<p>I was not able to find a package which accomplished this exact task
(although there probably is one somewhere), much less a package which
accomplished it quickly and with minimal memory overhead. Since these
package was designed to replace SQL database procedures the priorities
were correctness, memory efficiency, and speed in that order. But given
the amount of effort put into optimizing this, it’s almost exactly as
fast as a less memory efficient version.</p>
</div>
<div class="section level2">
<h2 id="integer-vs-numeric-intervals">Integer vs numeric intervals<a class="anchor" aria-label="anchor" href="#integer-vs-numeric-intervals"></a>
</h2>
<p>I made the intentional choice to disallow numeric intervals.
Restricting intervals to integer types (integer or class IDate) allowed
me to avoid having to foresee issues that would arise with numeric
intervals. If you’re dealing with continuous data and would like to use
this package, just discretize the data to your desired amount of
precision convert to those discrete periods to integers.</p>
</div>
<div class="section level2">
<h2 id="this-vignette">This vignette<a class="anchor" aria-label="anchor" href="#this-vignette"></a>
</h2>
<p>The remainder of this vignette describes some of the decision-making
behind how the intervalaverage function was written and may not be
interesting or useful to a general purpose audience.</p>
</div>
<div class="section level2">
<h2 id="a-brief-description-of-the-intervalaverage-algorithm-with-a-focus-on-explaining-why-seemingly-convoluted-choices-were-made-in-the-function-body">A brief description of the intervalaverage algorithm (with a focus
on explaining why seemingly convoluted choices were made in the function
body)<a class="anchor" aria-label="anchor" href="#a-brief-description-of-the-intervalaverage-algorithm-with-a-focus-on-explaining-why-seemingly-convoluted-choices-were-made-in-the-function-body"></a>
</h2>
<p>The <code>intervalaverage</code> function starts by merging periods
in y to periods in x by interval variables and possible grouping
variables using a non-equijoin. Technically speaking
<code>intervalaverage(x,y, interval_vars,group_vars)</code> performs a
right join on group_vars and non-equi joining (for partial overlaps) on
interval_vars. If intervals from x have start and end points [a,b] and
intervals from y have start and end points [c,d], the non-equi join for
partial overlaps requires that b&gt;=c &amp; a &lt;= d. </p>
<p>That resulting operation returns a joined table with two sets of
intervals. Those two sets of intervals can then be intersected (ie:
[max(a,b), min(c,d) ]) to identify the period of overlap. The length of
this period of overlap (min(c,d)-max(a,b)+1 ) is important in that it
determines the weight that the corresponding value from x will have when
trying to average that value into the interval from y ([c,d]).</p>
<p>This is all done directly in C++ because this code needs to have very
little overhead for a specific reason: namely that the non-equijoin is
repeatedly calling the average for each group in by=.EACHI. Previously
the function generated the entire intermediate table and operations
(such as taking products to calculate the weighted mean) could be done
once on the entire vectors in the intermediate table, but to save memory
I’m using the .EACHI technique which doesn’t ever allocate the
intermediate table (at least not all at once). Using this .EACHI
approach makes the function highly memory efficient (basically the only
things allocated other than the inputs is a table of the resulting join
subsetted to the largest group. This memory is then reused for each
group. This is data.table’s optimization, not mine, but at the time of
writing it is not well documented.)</p>
<p>Before describing the C++ code which does the above operation, I’ll
mention that there is one other memory optimization I implemented:
extreme care was taken to avoid copying x or y. This was challenging
since x and y needed to be modified in various ways prior to the join,
but this is all addressed via adding columns and/or possibly reordering
(for an error check)–all of this is reversed on function exit. I don’t
know much about situations where multiple parallel R processes are
sharing the same object at the same time, but if that’s something you
want to do you’ll definitely need to copy the objects first or else who
knows what will happen. Note when I say “multiple parallel R processes
sharing the same object at the same time” I’m not referring to standard
parallelization approaches like those used in library(parallel) or on a
cluster because I’m almost certain those always make copies when
forking.</p>
<p>In any case, the C code:</p>
<p>The C++ code takes the following inputs: - a list of values - a
vector of start integers from x - a vector of end integers from x - a
scalar–start integer from y - a scalar–end integer from y - a collated
vector of desired names in this form:
<code>c("valuevar1","nobs_valuevar1","valuevar2","nobs_valuevar2"...etc)</code>
which will determine the names of those columns in the return list of
the C function. I probably could have generated this in C but I was
having trouble figuring out text string manipulation.</p>
<p>The return is list contains precomputed columns (xduration, values,
nobs_values, and xminstart/xmaxend) as described in the help.</p>
<p>The C code is specifically designed to work with the conditions
generated by the non-equi join and should not be generalized to other
situations without major modification. Namely, because of the .EACHI
grouping, there is one set of y intervals and possibly multiple
xintervals (hence the scalar for y/vector for x). Additionally, all
intervals are assumed to be non-missing with the exception of a special
case: if any intervals in x are missing, they’re all assumed to be
missing and this only results when the .EACHI group does not contain ANY
matching rows from x–ie, the set of join conditions resulted in no
match. data.table will automatically generated a single row with
missings for the x variables. This is detected simply through the
presence of a missingness in the vector of start integers. The correct
output for this situation is generated manually (xminstart/xmaxend and
the average values are returned NA but xduration is returned as 0).</p>
<p>If nonmissing, the function proceeds to loop through each value
variable provided as the outer loop (indexed by j). Each j loop returns
two variables corresponding to the value variable: the
<em>nonmissing</em> (ie omitting NAs) average value as well as the
number of observations that the value variable had which contributed to
the average. This is less than or equal to xduration (equal to if that
value variable has no missings). Additionally, when j=0 (ie on the first
iteration), interval information–ie the length of the intersect as well
as xminstart/xmaxend– is determined (these are necessary to calculate
the weights for the average so this happens first in the loop).</p>
<p>This optimization and the abstractions which allow intervalaverage to
be called flexibly for arbitrary groups and number of values variables
make the intervalaverage function fairly intricate. This intricacy
(read: potential for bugs) is partially addressed by the large number of
error checks specified at the top of the R function body. (there are no
error checks in the C code as this would slow down the R function since
the C code is called repeatedly). Potential for bugs is further
addressed by the fact that I rewrote a slower but simpler version of the
averaging function using a different algorithm. The “unit tests” are
more than just unit tests–they’re a series of datasets passed through
both functions. Both functions return exactly identical results in all
cases or the checks fail so I can say with high certainty that despite
the level of abstraction involved that this function works as intended
at least in the use-cases that I’ve foreseen. With that said, if you
encounter a bug please let me know and I will patch it.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Michael Young.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
